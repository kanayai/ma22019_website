---
title: "MA22019 2025 - Solutions for Homework 8"
author: "Dr. Karim Anaya-Izquierdo"
format:
  html: default
  pdf: default
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
You may want to load the following packages before starting the exercise:

```{r, message=FALSE, warning=FALSE}
library( dplyr )
library( lubridate )
library( ggplot2 )
library( tidyr )
library( sf )
library( ggspatial )
library( prettymapr )
library( sp )
library( gstat )
```

When working on a University PC, you will have to first install some of these packages. 

### **Homework Question - Spatial dependence in temperatures across Brazil**

Let's again consider the temperature data from Brazil considered in Problem Sheet 6. The data are provided in the file "Brazil Temperature.csv". In the following we want to explore the spatial dependence in the data.

a) Estimate the semi-variogram for the data. What do you conclude about the spatial dependence in the observed temperatures?

<p style="color:blue"> *We estimate the semi-variogram using the variogram() function and then plot it:*</p>

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
Brazil <- read.csv( "data/Brazil Temperature.csv" )
coordinates( Brazil ) <- ~Lon+Lat
gamma_hat <- variogram( MeanTemp~1, data = Brazil, width=0.5 )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
  theme_bw() + labs( x="Distance", y="Semi-variogram" )
```

<p style="color:blue"> *The semi-variogram function seems to increase with increasing spatial distance. This suggests that the sptail dependence in the average temperature decreases with increasing spatial distance. Further, the function does not seem to flatten out, which corresponds to even sites are larger spatial dependence still showing some level of dependence.*</p>

b) Discuss whether it is reasonable to assume that the spatial random process has a constant mean and that the value of the semi-variogram is fully specified by the distance between spatial sites.

<p style="color:blue"> *Let's create a plot of the data:* </p>

```{r, warning=FALSE, message=FALSE, fig.align='center', out.width='70%'}
Temperature <- read.csv( "data/Brazil Temperature.csv" )

ggplot( Temperature, aes( x=Lon, y=Lat ) ) + 
  annotation_map_tile( zoom=5 ) + 
  geom_spatial_point( aes(color=MeanTemp), size=2 ) +
  scale_color_distiller( palette="Reds", trans="reverse" ) +
  labs( x="Longitude", y="Latitude", color="Mean Daily Temperature" )
```

* <p style="color:blue"> **Constant mean:** *This seems questionable since we would expect that some areas have higher average temperatures than others. For instance, sides closer to the sea may be exposed to a different climate than sites further inland. This is also visible in the plot above.*</p>

* <p style="color:blue"> **Non-stationarity and isotropy:** *This is a bit hard to assess due to the potential issue with the constant mean assumption. A simple check is to pick a couple of different areas across and assess whether (1) the difference in values of spatially close sites is similar and (2) whether the pattern in differences is comparable and not influenced by direction. Both of these points appear not unreasonable and thus we may conclude that the assumption holds that the semi-variogram is fully specified by the distance between spatial sites (when ignoring the constant mean issue). However, one may argue that there may be a directional affect related to exposure to the weather from the sea.*</p>


c) **Bonus:** One may argue that the constant mean assumption may not hold for the spatial process $\{X(\mathbf{s}) : \mathbf{s}\in\mathcal{S}\}$. The variogram() function allows us to define a model of the form
\begin{equation}
X(\mathbf{s}) = \beta_0  + \beta_1\mathrm{Longitude}(\mathbf{s}) + \beta_2\mathrm{Latitude}(\mathbf{s}) + Z(\mathbf{s}),
\end{equation}
where $\{Z(\mathbf{s}) : \mathbf{s}\in\mathcal{S}\}$ is termed the residual random process. The semi-variogram estimated by the variogram() function then corresponds to that for the residual random process. In R, we derive and visualize this estimate using

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
Brazil <- read.csv( "data/Brazil Temperature.csv" )
coordinates( Brazil ) <- ~Lon+Lat
gamma_hat <- variogram( MeanTemp ~Lon+Lat, data = Brazil, width=0.5 )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
  theme_bw() + labs( x="Distance", y="Semi-variogram" )
```

Describe the similarities and differences between this estimate and yours in part a). Discuss whether the conclusions we draw regarding spatial dependence in the residual process are the same as for the process in part a).   

**Remark:** You may learn more about the type of models in Equation (1) in Statistical Modelling & Data Analytics 3B.

<p style="color:blue"> *Both estimates for the semi-variogram function show that their values increase with increasing spatial distance. As such, spatial dependence in the average temperature seems to decrease with increasing spatial distance in both cases. One important difference is that the semi-variogram function for the residual process is flat from a distance of about 2, while this is not the case when considering the semi-variogram in part a). Consequently, observations of the residual process are close to independent when sites are further than a distance of 1.5-2.5 apart. We also see a difference in the values of the semi-variogram, especially for larger distances, but this observation does not really provide more insight.*</p>

<p style="color:blue"> *To summarize, there is a difference in the conclusions drawn from the two approaches in parts a) and c). Specifically, the approach in part c) somewhat accounts for the mean not being constant for all sites and thus we may argue that the results in part c) are more representative and better capture the actual process.*</p>

