<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>spatialdataanalysis – MA22019</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../slides.html" rel="next">
<link href="../lecture_notes/03-Text-Data-Analysis.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-bb1cd4028f63a369ab283e072cb7d572.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4f208714201d96898fd04a32119b1e84.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="style.css">
</head>
<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lecture_notes/index.html">Lecture Notes</a></li><li class="breadcrumb-item"><a href="../lecture_notes/04-SpatialDataAnalysis.html">Spatial Data Analysis</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Course Information</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Computing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing_setup/project_structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project Structure</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing_setup/setup_university_drive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">University Drive Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing_setup/computing_assignments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignments Workflow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../computing_setup/why_quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Why Quarto?</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Lecture Notes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lecture_notes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lecture_notes/01-DataWrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Wrangling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lecture_notes/02-DataVisualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lecture_notes/03-Text-Data-Analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Data Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lecture_notes/04-SpatialDataAnalysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Spatial Data Analysis</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slides</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Labs</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../homework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homework &amp; Quizzes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../coursework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coursework</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#spatial-data-analysis" id="toc-spatial-data-analysis" class="nav-link active" data-scroll-target="#spatial-data-analysis">Spatial Data Analysis</a>
  <ul class="collapse">
<li>
<a href="#visualizing-point-referenced-data" id="toc-visualizing-point-referenced-data" class="nav-link" data-scroll-target="#visualizing-point-referenced-data">Visualizing point-referenced data</a>
  <ul class="collapse">
<li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#shapefiles" id="toc-shapefiles" class="nav-link" data-scroll-target="#shapefiles">Shapefiles</a></li>
  <li><a href="#projections" id="toc-projections" class="nav-link" data-scroll-target="#projections">Projections</a></li>
  <li><a href="#maps" id="toc-maps" class="nav-link" data-scroll-target="#maps">Maps</a></li>
  </ul>
</li>
  <li>
<a href="#inverse-distance-weighting" id="toc-inverse-distance-weighting" class="nav-link" data-scroll-target="#inverse-distance-weighting">Inverse distance weighting</a>
  <ul class="collapse">
<li><a href="#mathematical-framework" id="toc-mathematical-framework" class="nav-link" data-scroll-target="#mathematical-framework">Mathematical framework</a></li>
  <li><a href="#performing-inverse-distance-weighting-in-r" id="toc-performing-inverse-distance-weighting-in-r" class="nav-link" data-scroll-target="#performing-inverse-distance-weighting-in-r">Performing inverse distance weighting in R</a></li>
  <li><a href="#creating-spatial-plots-with-inverse-distance-weighting" id="toc-creating-spatial-plots-with-inverse-distance-weighting" class="nav-link" data-scroll-target="#creating-spatial-plots-with-inverse-distance-weighting">Creating spatial plots with inverse distance weighting</a></li>
  </ul>
</li>
  <li>
<a href="#variogram" id="toc-variogram" class="nav-link" data-scroll-target="#variogram">Variogram</a>
  <ul class="collapse">
<li><a href="#motivation-1" id="toc-motivation-1" class="nav-link" data-scroll-target="#motivation-1">Motivation</a></li>
  <li><a href="#mathematical-framework-1" id="toc-mathematical-framework-1" class="nav-link" data-scroll-target="#mathematical-framework-1">Mathematical framework</a></li>
  <li><a href="#estimation-of-the-semi-variogram" id="toc-estimation-of-the-semi-variogram" class="nav-link" data-scroll-target="#estimation-of-the-semi-variogram">Estimation of the semi-variogram</a></li>
  <li><a href="#analysis-of-sea-surface-temperature-anomalies" id="toc-analysis-of-sea-surface-temperature-anomalies" class="nav-link" data-scroll-target="#analysis-of-sea-surface-temperature-anomalies">Analysis of sea surface temperature anomalies</a></li>
  </ul>
</li>
  <li>
<a href="#principal-component-analysis" id="toc-principal-component-analysis" class="nav-link" data-scroll-target="#principal-component-analysis">Principal Component Analysis</a>
  <ul class="collapse">
<li><a href="#motivation-2" id="toc-motivation-2" class="nav-link" data-scroll-target="#motivation-2">Motivation</a></li>
  <li><a href="#analyzing-spatial-structure" id="toc-analyzing-spatial-structure" class="nav-link" data-scroll-target="#analyzing-spatial-structure">Analyzing spatial structure</a></li>
  <li><a href="#example-precipitation-across-colorado-united-states" id="toc-example-precipitation-across-colorado-united-states" class="nav-link" data-scroll-target="#example-precipitation-across-colorado-united-states">Example: Precipitation across Colorado, United States</a></li>
  </ul>
</li>
  <li><a href="#visualizing-point-pattern-data" id="toc-visualizing-point-pattern-data" class="nav-link" data-scroll-target="#visualizing-point-pattern-data">Visualizing point pattern data</a></li>
  <li>
<a href="#intensity-of-a-point-process" id="toc-intensity-of-a-point-process" class="nav-link" data-scroll-target="#intensity-of-a-point-process">Intensity of a point process</a>
  <ul class="collapse">
<li><a href="#motivation-3" id="toc-motivation-3" class="nav-link" data-scroll-target="#motivation-3">Motivation</a></li>
  <li><a href="#quadrat-counting" id="toc-quadrat-counting" class="nav-link" data-scroll-target="#quadrat-counting">Quadrat counting</a></li>
  <li><a href="#kernel-smoothed-intensity" id="toc-kernel-smoothed-intensity" class="nav-link" data-scroll-target="#kernel-smoothed-intensity">Kernel smoothed intensity</a></li>
  <li><a href="#tornadoes-across-the-united-states" id="toc-tornadoes-across-the-united-states" class="nav-link" data-scroll-target="#tornadoes-across-the-united-states">Tornadoes across the United States</a></li>
  </ul>
</li>
  <li>
<a href="#visualizing-lattice-data" id="toc-visualizing-lattice-data" class="nav-link" data-scroll-target="#visualizing-lattice-data">Visualizing lattice data</a>
  <ul class="collapse">
<li><a href="#population-density-across-london-boroughs" id="toc-population-density-across-london-boroughs" class="nav-link" data-scroll-target="#population-density-across-london-boroughs">Population density across London boroughs</a></li>
  <li><a href="#tornadoes-across-the-united-states-1" id="toc-tornadoes-across-the-united-states-1" class="nav-link" data-scroll-target="#tornadoes-across-the-united-states-1">Tornadoes across the United States</a></li>
  </ul>
</li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lecture_notes/index.html">Lecture Notes</a></li><li class="breadcrumb-item"><a href="../lecture_notes/04-SpatialDataAnalysis.html">Spatial Data Analysis</a></li></ol></nav></header><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
</div>
<section id="spatial-data-analysis" class="level1"><h1>Spatial Data Analysis</h1>
<p>In many applications we have information on the location where the data were observed. Applications for which such spatial information is often available include:</p>
<ul>
<li><p><strong>Disease modelling</strong>: Knowledge of where infected patients are living allows us to identify the population at risk and to explore disease dynamics.</p></li>
<li><p><strong>Socioeconomic studies</strong>: Data on income, access to schools and social activities are collected across administrative areas.</p></li>
<li><p><strong>Weather data</strong>: Observations are collected at several weather stations and then used to predict the weather across the country.</p></li>
</ul>
<p>In this chapter we explore how to analyze effectively data in such applications. We start by introducing the three types of <strong>spatial data</strong>:</p>
<dl>
<dt><strong>Point-referenced data:</strong></dt>
<dd>
<p>Data is collected at a fixed set of spatial locations. Such data are, for instance, analyzed in meteorology, hydrology, public health (pollution levels), where the locations of the measurement stations are given by their longitude and latitude coordinates (and possibly altitude).</p>
</dd>
<dt><strong>Point pattern data:</strong></dt>
<dd>
<p>Differs from point-referenced data in that spatial locations themselves are random. This type of data occurs, for instance, when monitoring disease outbreaks and conducting ecological studies, where the locations of the observations are unknown until we start collecting the data.</p>
</dd>
<dt><strong>Lattice/Areal data:</strong></dt>
<dd>
<p>Differs from point-referenced data in that observations represent information about fixed spatial areas instead of spatial points. For instance, when analyzing insurance claims, we may have access to the number of claims for a postcode area, but no information on the individual claims.</p>
</dd>
</dl>
<p>Sections <a href="Visualizing point-referenced data">4.1</a> to <a href="Principal Component Analysis">4.4</a> focus on the analysis of point-referenced data, and we will consider visualization of the other types of spatial data in Sections <a href="Visualizing point pattern data">4.5</a> to <a href="Visualizing lattice data">4.7</a>.</p>
<section id="visualizing-point-referenced-data" class="level2"><h2 class="anchored" data-anchor-id="visualizing-point-referenced-data">Visualizing point-referenced data</h2>
<section id="motivation" class="level3"><h3 class="anchored" data-anchor-id="motivation">Motivation</h3>
<p>The file “Temperature Germany.csv” contains the maximum temperature recorded on 1 May 2020 for 75 weather stations across Germany. Let’s look at the provided variables</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Temperature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Temperature Germany.csv"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span> <span class="va">Temperature</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "name"      "latitude"  "longitude" "altitude"  "max.temp" </code></pre>
</div>
</div>
<p>Our variable of interest is <strong>max.temp</strong>, the recorded maximum temperature, and <strong>latitude</strong>, <strong>latitude</strong> and <strong>altitude</strong> specify the spatial locations of the 75 weather stations.</p>
<p>We can already create a first plot of maximum daily temperature at different locations using ggplot2:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">Temperature</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">longitude</span>, y<span class="op">=</span><span class="va">latitude</span> <span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">max.temp</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">2.5</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, color<span class="op">=</span><span class="st">"Temperature"</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span> axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span>, axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/Germany0-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Illustration of daily maximum temperature recorded at 75 weather stations across Germany. We use colour as a visual cue to illustrate differences in maximum temperature.</figcaption></figure>
</div>
</div>
</div>
<p><strong>Is this really the best way to plot the data?</strong></p>
<p>One may argue that the plot is not ideal since it does not provide any spatial context, that is, we cannot relate the illustrated values and locations to any known geographical features.</p>
<p>We now introduce two approaches for visualizing point-referenced data, both of which aim to provide additional spatial context to aid interpretation. The first approach uses <strong>shapefiles</strong> which allow us to add the outline of Germany, that is its borders, to the plot. The second approach will place the points upon a map.</p>
</section><section id="shapefiles" class="level3"><h3 class="anchored" data-anchor-id="shapefiles">Shapefiles</h3>
<p>Administrative boundaries can be described as a polygon with a potentially very large number of edges. In some cases we may also deal with several polygons. For instance, when considering the UK, we would have one polygon per island. Such polygons are specified via a <strong>shapefile (.shp)</strong> and can be used in R.</p>
<p>The administrative boundaries of countries are freely available from <a href="https://gadm.org/download_country.html"> www.gadm.org </a> for educational and academic use. Let’s download the data for Germany and load the Level 1 data into R using the function <strong>read_sf()</strong> in the <strong>sf</strong> R package</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="va">GER</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span> <span class="st">"Data/gadm41_DEU_shp/gadm41_DEU_1.shp"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Important:</strong> You need all the downloaded files, not just the .shp file.</p>
<p><strong>Remark:</strong> The Level 0 shapefile only contains the borders, while higher levels (Level 1, etc.) also provide administrative boundaries within the country - this applies to all countries listed on <a href="https://gadm.org/download_country.html"> www.gadm.org </a>.</p>
<p>We plot the boundaries using <strong>geom_sf()</strong> from the sf package in combination with ggplot():</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">GER</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:65.0%"></p>
<figcaption>Administrative boundaries of the 16 German states.</figcaption></figure>
</div>
</div>
</div>
<p><strong>IMPORTANT:</strong> The shapefiles provided by GADM are very large, and I noticed that some laptops may struggle to create the plot. Should you have this issue, you may want to use the function <strong>st_simplify()</strong> to reduce the complexity of your polygon - the function has a parameter <strong>dTolerance</strong> which specifies how much the “wiggles” in the polygon will be straightened. Let’s set <strong>dTolerance=2000</strong> for the shapefile considered above</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GER_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span> <span class="va">GER</span>, dTolerance <span class="op">=</span> <span class="fl">2000</span>, preserveTopology<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">GER_simple</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" style="width:65.0%"></p>
<figcaption>Approximation of the administrative boundaries of the 16 German states with simplified borders.</figcaption></figure>
</div>
</div>
</div>
<p>We see only very minor changes in the plot, and these are unlikely to affect our analysis. If we set <strong>dTolerance</strong> too large, we may get a shape that looks too different from the original file. As such, we have to be a bit careful with the value we specify for <strong>dTolerance</strong>.</p>
<p>Moving on with our analysis, the final step is to add the data points displayed in Figure @ref(fig:Germany0) to the plot above. As such, our data graphic is made up of two layers - one for the shapefile and one for the data points. The order is important now because ggplot2 builds the plot layer by layer:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">GER</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">Temperature</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">longitude</span>, y<span class="op">=</span><span class="va">latitude</span>, color<span class="op">=</span><span class="va">max.temp</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">3</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, color<span class="op">=</span><span class="st">"Temperature"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:77.0%"></p>
<figcaption>Illustration of daily maximum temperature recorded at 75 weather stations across Germany. The visual cue colour is used to represent maximum temperature.</figcaption></figure>
</div>
</div>
</div>
<p>Note, we deviate from the format used in Chapter [2][Data Visualization], because we are now working with two data frames - one for the boundaries and another for the weather data. Therefore, we have to specify the data for the points separately in geom_point().</p>
</section><section id="projections" class="level3"><h3 class="anchored" data-anchor-id="projections">Projections</h3>
<p>So far we have used longitude and longitude within a Cartesian coordinate system. However, the earth is a three-dimensional flattened sphere and thus it is not flat. The process of converting locations in a three-dimensional <strong>geographic coordinate system</strong> to a two-dimensional representation is called <strong>projection</strong>.</p>
<p>There exists a wide range of projections because no projection can preserve all properties at the same time, in particular <strong>shape/angle</strong> and <strong>area</strong>.</p>
<p>We can change projections with the <strong>coord_sf()</strong> function from the sf package. Let’s compare some possible projections applied to Canada and Norway:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">CANADA</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"Data/gadm41_CAN_shp/gadm41_CAN_1.shp"</span><span class="op">)</span></span>
<span><span class="va">CANADA</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span> <span class="va">CANADA</span>, dTolerance <span class="op">=</span> <span class="fl">5000</span> <span class="op">)</span></span>
<span><span class="va">CANPlot1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">CANADA</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">CANPlot2</span> <span class="op">&lt;-</span> <span class="va">CANPlot1</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span> crs<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">3347</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">NORWAY</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"Data/gadm41_NOR_shp/gadm41_NOR_1.shp"</span><span class="op">)</span></span>
<span><span class="va">NORWAY</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span> <span class="va">NORWAY</span>, dTolerance <span class="op">=</span> <span class="fl">2000</span> <span class="op">)</span></span>
<span><span class="va">NORPlot1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">NORWAY</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">NORPlot2</span> <span class="op">&lt;-</span> <span class="va">NORPlot1</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span> crs<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">3346</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span> <span class="va">CANPlot1</span> <span class="op">+</span> <span class="va">CANPlot2</span> <span class="op">)</span> <span class="op">/</span> <span class="op">(</span> <span class="va">NORPlot1</span> <span class="op">+</span> <span class="va">NORPlot2</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Administrative boundaries of Canada (top) and Norway (bottom). The left plots preserve the angels, while the right plots do better at highlighting that the countries are located on a sphere.</figcaption></figure>
</div>
</div>
</div>
<p>In the left plots the meridians and parallels are orthogonal and, thus, these projections are angle-preserving. This projection is also known as the <strong>WGS84 coordinate reference system</strong>, which is the standard for GPS systems and Google Earth. In the right plots, we do not preserve the angels, but we better visualize that we are working with data on a three-dimensional sphere. As data scientists, we should be aware that our choice of projection may have a direct influence on how the plot is perceived by others. While such aspects are negligible when analyzing data across small spatial areas, we should keep this in mind when considering spatial data collected across large spatial scales.</p>
<p><strong>Remark:</strong> You have to experiment a bit with the value in <strong>st_crs()</strong> when creating plots. A value of 4326 corresponds to the WGS84 system.</p>
</section><section id="maps" class="level3"><h3 class="anchored" data-anchor-id="maps">Maps</h3>
<p>So far we added boundaries to a plot to aid the reader’s orientation. When we consider the German weather data, we find that the data set also provides altitude. However, such information is difficult to incorporate within a shape file. Therefore, it may be better to provide a map that indicates larger water bodies and possibly elevation.</p>
<p>We use the <strong>ggspatial</strong> R package to import maps provided by OpenStreetMap and then plot the points onto them. This requires us to include the <strong>annotation_map_tile()</strong> function to our ggplot2 commands and replace geom_point() by <strong>geom_spatial_point()</strong>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">Temperature</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">longitude</span>, y<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/stat_spatial_identity.html">geom_spatial_point</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">max.temp</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">3</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, color<span class="op">=</span><span class="st">"Temperature"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/GERMap-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>Temperature recorded at 75 weather stations across Germany, with Open Street Map being used to illustrate geographical features.</figcaption></figure>
</div>
</div>
</div>
<p><strong>Remark:</strong> There are different types of maps provided by the ggspatial package, but they are not relevant for the examples we consider in this course.</p>
<p>While this type of map is not great at visualizing altitude, we can observe that the temperature tends to be lower for higher altitudes and for locations close to the sea (this is what we would expect).</p>
</section></section><section id="inverse-distance-weighting" class="level2"><h2 class="anchored" data-anchor-id="inverse-distance-weighting">Inverse distance weighting</h2>
<p>After visualizing the data we now consider the task of making a prediction at an unobserved location. Let <span class="math inline">\(x_1,\ldots,x_n\)</span> and <span class="math inline">\(\mathbf{s}_1,\ldots,\mathbf{s}_n\)</span> denote the observed values and locations respectively; <span class="math inline">\(\mathbf{s}_1,\ldots,\mathbf{s}_n\)</span> are often described by their longitude and latitude and are located within a bounded area <span class="math inline">\(\mathcal{S}\subset\mathbb{R}^2\)</span>.</p>
<p>Consider the German temperature data in Figure @ref(fig:GERMap). How would you use the data across the 75 weather stations if you were asked to provide a prediction <span class="math inline">\(x^*\)</span> at an unobserved location <span class="math inline">\(\mathbf{s}^*\)</span>?</p>
<p>Intuitively, the values at locations geographically close to <span class="math inline">\(\mathbf{s}^*\)</span> may provide the most useful information. <strong>Inverse distance weighting</strong> puts this idea into a mathematical framework, and it falls into the category of <strong>spatial interpolation</strong> techniques. The approach postulates that the predicted value <span class="math inline">\(x^*\)</span> at <span class="math inline">\(\mathbf{s}^*\)</span> is a weighted average of the observed data points, with higher weighting given to locations that are geographically close to <span class="math inline">\(\mathbf{s}^*\)</span>. We will formalize this approach in the following and see how to perform it in R.</p>
<section id="mathematical-framework" class="level3"><h3 class="anchored" data-anchor-id="mathematical-framework">Mathematical framework</h3>
<p>Let <span class="math inline">\(d:\mathbb{R}^2 \times \mathbb{R}^2 \to \mathbb{R}_+\)</span> be a metric that defines a distance between any two points <span class="math inline">\(\mathbf{s}_1=(s_{11},s_{12})\in\mathbb{R}^2\)</span> and <span class="math inline">\(\mathbf{s}_2=(s_{21}, s_{22})\in \mathbb{R}^2\)</span>. The most commonly used distance metric is the L<span class="math inline">\(_2\)</span> norm/Euclidian distance:</p>
<p><span class="math display">\[\begin{equation}
d(\mathbf{s}_1, \mathbf{s}_2) = ||\mathbf{s}_1-\mathbf{s}_2||_2= \sqrt{(s_{11}-s_{21})^2 + (s_{12}-s_{22})^2}.
(\#eq:Euclidian)
\end{equation}\]</span></p>
<p>Inverse distance weighting defines the predicted value <span class="math inline">\(x^*\)</span> at the unobserved location <span class="math inline">\(\mathbf{s}^*\)</span> as <span class="math display">\[\begin{equation}
x^* =
\begin{cases}
\dfrac{\sum_{i=1}^n w(\mathbf{s}_i,\mathbf{s}^*) x_i}{\sum_{i=1}^n, w(\mathbf{s}_i,\mathbf{s}^*)} &amp; \mbox{if}~d(\mathbf{s}^*, \mathbf{s}_i)&gt;0~\mbox{for all } i=1,\ldots,n,\\
x_i &amp; \mathrm{if}~d(\mathbf{s}^*, \mathbf{s}_i)=0,
\end{cases}
(\#eq:IDW)
\end{equation}\]</span> where <span class="math inline">\(w(\mathbf{s}_i,\mathbf{s}^*) = \left[d(\mathbf{s}_i,\mathbf{s}^*)\right]^{-p}\)</span> and <span class="math inline">\(p&gt;0\)</span> is called the <strong>power parameter</strong> and has to be selected by us. One important rule to remember is that the weight given to the observation closest to <span class="math inline">\(\mathbf{s}^*\)</span> increases with <span class="math inline">\(p\)</span>; we will see this when plotting the calculated predicted values later for different values of <span class="math inline">\(p\)</span>.</p>
</section><section id="performing-inverse-distance-weighting-in-r" class="level3"><h3 class="anchored" data-anchor-id="performing-inverse-distance-weighting-in-r">Performing inverse distance weighting in R</h3>
<p>There exist R functions to perform inverse distance weighting, but we will implement our own function <strong>IDW()</strong> combines equations @ref(eq:Euclidian) and @ref(eq:IDW). This will make it easier to plot our predictions.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">IDW</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span> <span class="va">X</span>, <span class="va">S</span>, <span class="va">s_star</span>, <span class="va">p</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span> <span class="op">(</span><span class="va">S</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">s_star</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">S</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="va">s_star</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">)</span></span>
<span>  <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="va">p</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span> <span class="va">X</span> <span class="op">*</span> <span class="va">w</span> <span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span> <span class="va">w</span> <span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="kw">else</span> </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="va">X</span><span class="op">[</span><span class="va">d</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Suppose we want to use the German weather data to predict the maximum temperature on 1 May 2020 at an unobserved location with longitude 13.1 and latitude 51.0, <span class="math inline">\(\mathbf{s}^* = (13.1, 51.0)\)</span>. We consider the settings <span class="math inline">\(p=0.5\)</span> and <span class="math inline">\(p=2\)</span> for the power parameter and obtain the following values for <span class="math inline">\(x^*\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span> <span class="va">Temperature</span><span class="op">$</span><span class="va">longitude</span>, <span class="va">Temperature</span><span class="op">$</span><span class="va">latitude</span> <span class="op">)</span></span>
<span><span class="va">s_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="fl">13.1</span>, <span class="fl">51.0</span> <span class="op">)</span></span>
<span><span class="fu">IDW</span><span class="op">(</span> X<span class="op">=</span><span class="va">Temperature</span><span class="op">$</span><span class="va">max.temp</span>, S<span class="op">=</span><span class="va">coord</span>, <span class="va">s_star</span>, p<span class="op">=</span><span class="fl">0.5</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 23.4665</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">IDW</span><span class="op">(</span> X<span class="op">=</span><span class="va">Temperature</span><span class="op">$</span><span class="va">max.temp</span>, S<span class="op">=</span><span class="va">coord</span>, <span class="va">s_star</span>, p<span class="op">=</span><span class="fl">2.0</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 22.67209</code></pre>
</div>
</div>
<p>We see that the two settings for <span class="math inline">\(p\)</span> give predictions that differ by almost 1 degree Celsius. Consequently, the selection of <span class="math inline">\(p\)</span> is indeed crucial and we will consider its selection in more detail in the next part.</p>
</section><section id="creating-spatial-plots-with-inverse-distance-weighting" class="level3"><h3 class="anchored" data-anchor-id="creating-spatial-plots-with-inverse-distance-weighting">Creating spatial plots with inverse distance weighting</h3>
<p>We want to make predictions across the whole study space, instead of a single location <span class="math inline">\(\mathbf{s}^*\)</span>. Here we visualize these predictions across a map, which is also useful to identify suitable values for <span class="math inline">\(p\)</span>.</p>
<p>The first step is to define a grid that covers the study space <span class="math inline">\(\mathcal{S}\)</span>. Here, we will simply define <span class="math inline">\(\mathcal{S}\)</span> as a rectangle (based on longitude and latitude coordinates):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">points_lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span> <span class="fl">47.1</span>, <span class="fl">55.1</span>, by<span class="op">=</span><span class="fl">0.05</span> <span class="op">)</span></span>
<span><span class="va">points_lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span> <span class="fl">5.8</span>, <span class="fl">15.6</span>, by<span class="op">=</span><span class="fl">0.05</span> <span class="op">)</span></span>
<span><span class="va">pixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span> <span class="va">points_lon</span>, <span class="va">points_lat</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We then apply our implemented <strong>IDW()</strong> function to the grid points with the power parameter being set to <span class="math inline">\(p=0.5\)</span>, <span class="math inline">\(p=2.0\)</span> and <span class="math inline">\(p=20\)</span>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p05</span> <span class="op">&lt;-</span> <span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">p20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span> <span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pixels</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p05</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">IDW</span><span class="op">(</span> X<span class="op">=</span><span class="va">Temperature</span><span class="op">$</span><span class="va">max.temp</span>, S<span class="op">=</span><span class="va">coord</span>, s_star<span class="op">=</span><span class="va">pixels</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span>, p<span class="op">=</span><span class="fl">0.5</span> <span class="op">)</span></span>
<span>  <span class="va">p2</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>  <span class="op">&lt;-</span> <span class="fu">IDW</span><span class="op">(</span> X<span class="op">=</span><span class="va">Temperature</span><span class="op">$</span><span class="va">max.temp</span>, S<span class="op">=</span><span class="va">coord</span>, s_star<span class="op">=</span><span class="va">pixels</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span>, p<span class="op">=</span><span class="fl">2.0</span> <span class="op">)</span></span>
<span>  <span class="va">p20</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">IDW</span><span class="op">(</span> X<span class="op">=</span><span class="va">Temperature</span><span class="op">$</span><span class="va">max.temp</span>, S<span class="op">=</span><span class="va">coord</span>, s_star<span class="op">=</span><span class="va">pixels</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span>, p<span class="op">=</span><span class="fl">20</span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The next step is to collate the estimates into a data frame so that we can plot the predictions:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="va">Predict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span> <span class="st">"Lon"</span><span class="op">=</span><span class="va">pixels</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="st">"Lat"</span><span class="op">=</span><span class="va">pixels</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, </span>
<span>                       <span class="st">"p0.5"</span><span class="op">=</span><span class="va">p05</span>, <span class="st">"p2"</span><span class="op">=</span><span class="va">p2</span>, <span class="st">"p20"</span><span class="op">=</span><span class="va">p20</span> <span class="op">)</span></span>
<span><span class="va">Predict</span> <span class="op">&lt;-</span> <span class="va">Predict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span> cols<span class="op">=</span><span class="va">p0.5</span><span class="op">:</span><span class="va">p20</span>, names_to <span class="op">=</span> <span class="st">"Power"</span> <span class="op">)</span></span>
<span><span class="va">Predict</span> <span class="op">&lt;-</span> <span class="va">Predict</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span> Power <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span> <span class="va">Power</span> <span class="op">==</span> <span class="st">"p0.5"</span> <span class="op">~</span> <span class="st">"p=0.5"</span>, <span class="va">Power</span> <span class="op">==</span> <span class="st">"p2"</span> <span class="op">~</span> <span class="st">"p=2.0"</span>,</span>
<span>                             .default <span class="op">=</span> <span class="st">"p=20"</span> <span class="op">)</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Finally, we plot the grid and the calculated predictions. We add the boundaries of Germany and the locations of the weather stations to the plot to provide some spatial context:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">Predict</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_raster</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">Lon</span>, y<span class="op">=</span><span class="va">Lat</span>, fill<span class="op">=</span><span class="va">value</span> <span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span><span class="va">Power</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">GER</span>, alpha<span class="op">=</span><span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"white"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">Temperature</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">longitude</span>, y<span class="op">=</span><span class="va">latitude</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> fill<span class="op">=</span><span class="st">"°C"</span>, x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Predicted values of maximum daily temperature on May 1, 2020 for Germany and adjacent regions using inverse distance weighting with three values for the power paramter.</figcaption></figure>
</div>
</div>
</div>
<p><strong>What do we notice?</strong></p>
<p>When considering the range of the colour bars, we notice that <span class="math inline">\(p=0.5\)</span> leads to the estimated temperatures being much less varied than for <span class="math inline">\(p=2\)</span>. Further, <span class="math inline">\(p=20\)</span> produces unrealistic predictions and should not be selected, since we predict sudden changes in temperature across space, with the predicted value being almost only determined by the value observed at the location closest to <span class="math inline">\(\mathbf{s}^*\)</span>; the latter is also referred to as a tessellation of the region.</p>
<p>The difference in the range of predicted values for the different values of <span class="math inline">\(p\)</span> can be explained by that the weight given to the observation closest to <span class="math inline">\(\mathbf{s}^*\)</span> increases with <span class="math inline">\(p\)</span> - we highlighted this aspect earlier. These findings give us some guidance on the selection of <span class="math inline">\(p\)</span>:</p>
<ul>
<li><p><span class="math inline">\(p\)</span> should be small enough to avoid tessellation, unless we believe such a feature is realistic;</p></li>
<li><p><span class="math inline">\(p\)</span> should be large enough to give predictions that are similar in range to the observed values.</p></li>
</ul>
<p>The range of predicted values for <span class="math inline">\(p=0.5\)</span> is in fact substantially smaller than the range of observed values in Figure @ref(fig:GERMap) - we predict temperatures above 20 degrees Celsius even for the highest mountains, although the true value is probably much lower. This suggests that <span class="math inline">\(p=0.5\)</span> is too small and that <span class="math inline">\(p=2\)</span> performs best amongst the considered values, because we have both a range of predictions similar to the observed data and the produced prediction map still appears relatively smooth.</p>
<p><strong>Remark 1:</strong> We ignored that temperature depends on altitude in our analysis. If we had access to altitude for each point on the grid, we could extend the distance measure in Equation @ref(eq:Euclidian) to incorporate latitude, longitude and altitude in the inverse distance weighting estimates.</p>
<p><strong>Remark 2:</strong> We selected <span class="math inline">\(p\)</span> “by eye”. We may use cross-validation (which some of you may have seen in MA22018) to find the value <span class="math inline">\(p\)</span> that performs best in terms of prediction.</p>
<p><strong>Remark 3:</strong> Care should be taken when using inverse distance weighting to make predictions for a location <span class="math inline">\(\mathbf{s}^*\)</span> that is not close to <span class="math inline">\(\mathbf{s}_1,\ldots,\mathbf{s}_n\)</span>. For instance, we should not use the temperature data from Germany to predict the temperature for Bath.</p>
</section></section><section id="variogram" class="level2"><h2 class="anchored" data-anchor-id="variogram">Variogram</h2>
<section id="motivation-1" class="level3"><h3 class="anchored" data-anchor-id="motivation-1">Motivation</h3>
<p>We now move on to exploring and quantifying spatial dependence, that is, how informative is the data at one location to say something about near-by locations. This is a key aspect underlying the majority of spatial data analysis methods. For instance, inverse distance weighting makes the assumption that data collected at the locations <span class="math inline">\(\mathbf{s}_1,\ldots,\mathbf{s}_n\)</span> is useful to make predictions at unobserved locations, and that locations closest to the unobserved location provide the most information.</p>
<p>In the examples considered so far, such as the German weather data in Figure @ref(fig:GERMap), we found that spatially close sites tend to have similar values.</p>
<p>As a second motivating data example, let’s consider the recorded sea surface temperature anomalies for the North Sea for 1 November 2024 (provided in the file “SeaSurface.csv”) as recorded by NOAA:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SSTA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Sea Surface Temperature Anomalies.csv"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Observations are on a 5km resolution. To create a plot of the data, we first have to convert the data frame providing longitude, latitude and sea surface temperature into a spatial data object using <strong>st_as_sf()</strong>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SSTA_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span> <span class="va">SSTA</span>, coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_set_crs</a></span><span class="op">(</span> <span class="fl">4326</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can now create the plot with geom_sf():</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">SSTA_sf</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">Anomaly</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, color<span class="op">=</span><span class="st">"SST Anomaly"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/SST-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Sea surface temperature anomalies on 1 November 2024 for the North Sea as recorded by NOAA.</figcaption></figure>
</div>
</div>
</div>
<p>The plot shows that locations which are spatially close observe a similar value. We now want to quantify this similarity of values of spatially close sites using the <strong>variogram</strong> which is based on concepts we are familiar with from Year 1 Probability and Statistics.</p>
</section><section id="mathematical-framework-1" class="level3"><h3 class="anchored" data-anchor-id="mathematical-framework-1">Mathematical framework</h3>
<p>We already came across dependence of two random variables in Year 1. To explore dependence between two random variables <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, we considered the covariance [ (X,Y) = = (XY) - X Y. ] In a spatial context, we now consider the observation at a spatial site as the realization of a random variable, with the random variables at any two sites being potentially dependent. This leads to the concept of a <strong>random field</strong>, which is also referred to as a <strong>spatial random process</strong>.</p>
<p><strong>Definition:</strong> A random field <span class="math inline">\(\{X(\mathbf{s}):\mathbf{s}\in\mathcal{S}\}\)</span> is a family of random variables that are defined on the same probability space and indexed by the spatial location <span class="math inline">\(\mathbf{s}\in\mathcal{S}\)</span>.</p>
<p>For the sea surface data, <span class="math inline">\(X(\mathbf{s})\)</span> describes the distribution of the sea surface temperature anomaly at location <span class="math inline">\(\mathbf{s}\in\mathcal{S}\)</span>. Further, Figure @ref(fig:SST) corresponds to a single sample from the random field.</p>
<p>Consider an arbitrary pair <span class="math inline">\((\mathbf{s},\tilde{\mathbf{s}})\)</span> of sites across the region <span class="math inline">\(\mathcal{S}\)</span>. While dependence of <span class="math inline">\(X(\mathbf{s})\)</span> and <span class="math inline">\(X(\tilde{\mathbf{s}})\)</span> may be quantified via their covariance, we usually use the <strong>semi-variogram</strong> in spatial data analysis:</p>
<p><strong>Definition:</strong> The semi-variogram for the locations <span class="math inline">\(\mathbf{s}\)</span> and <span class="math inline">\(\tilde{\mathbf{s}}\)</span> is defined as [ (,) = . ]</p>
<p>From now on we make the assumption that <span class="math inline">\(\mathbb{E}\left[X(\mathbf{s})\right]\)</span> is the same for all <span class="math inline">\(\mathbf{s}\in\mathcal{S}\)</span>. Consequently, the expression for the semi-variogram simplifies to half the average squared difference between the values at these locations,</p>
<p><span class="math display">\[\begin{equation}
\gamma(\mathbf{s},\tilde{\mathbf{s}}) = \frac{1}{2} \mathbb{E}\left[\{X(\mathbf{s})-X(\tilde{\mathbf{s}})\}^2\right] = \frac{1}{2} \mathrm{Var}\left[X(\mathbf{s})-X(\tilde{\mathbf{s}})\right].
(\#eq:Semivariogram)
\end{equation}\]</span></p>
<p>The semi-variogram has several important properties:</p>
<ul>
<li><p><span class="math inline">\(\gamma(\mathbf{s},\tilde{\mathbf{s}})\geq 0\)</span> since it is the expectation of a square, with smaller values corresponding to stronger dependence.</p></li>
<li><p>If <span class="math inline">\(\mathbf{s}=\tilde{\mathbf{s}}\)</span>, we have <span class="math inline">\(\gamma(\mathbf{s},\tilde{\mathbf{s}})=0\)</span>.</p></li>
<li><p>If <span class="math inline">\(X(\mathbf{s})\)</span> and <span class="math inline">\(X(\tilde{\mathbf{s}})\)</span> are independent and identically distributed, [ (,)=[X()]=[X()]. ]</p></li>
</ul></section><section id="estimation-of-the-semi-variogram" class="level3"><h3 class="anchored" data-anchor-id="estimation-of-the-semi-variogram">Estimation of the semi-variogram</h3>
<p>We want to estimate <span class="math inline">\(\gamma(\mathbf{s},\tilde{\mathbf{s}})\)</span> in expression @ref(eq:Semivariogram) using the observations <span class="math inline">\(x_1,\ldots,x_n\)</span> and locations <span class="math inline">\(\mathbf{s}_1,\ldots,\mathbf{s}_n\)</span>.</p>
<p>The main challenge is that we only have a single observation at each of the <span class="math inline">\(n\)</span> locations. For instance, if we were to derive an estimate for <span class="math inline">\(\gamma(\mathbf{s}_1,\mathbf{s}_2)\)</span> using <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> only, we would have <span class="math inline">\(\gamma(\mathbf{s}_1,\mathbf{s}_2)=\frac{1}{2}(x_1-x_2)^2\)</span>. However, such an estimate is likely to be poor. This is a common problem in spatial data analysis and applies to all the examples considered so far.</p>
<p>To make use of all the data available, we make the assumptions that the random field is <strong>stationary</strong> and <strong>isotropic</strong>. Simply speaking, these assumptions imply that for any pair (<span class="math inline">\(\mathbf{s},\tilde{\mathbf{s}}\)</span>) of locations <span class="math inline">\(\gamma(\mathbf{s},\tilde{\mathbf{s}})\)</span> is fully specified by their spatial distance. As such, there exists a function <span class="math inline">\(\tilde{\gamma}:\mathbb{R}\to\mathbb{R}_+\)</span> such that for all <span class="math inline">\(\mathbf{s},\tilde{\mathbf{s}}\in\mathcal{S}\)</span> [ (,) = ( || - || ). ]</p>
<p><strong>Important:</strong> You have to carefully consider whether the assumption holds that dependence is fully described by spatial distance. If this is not the case, you should not apply the following estimation procedure.</p>
<p><strong>Remark:</strong> The concepts of stationarity and isotropy will be introduced more formally in MA32024 Statistical Modelling and Data Analytics 3B. In this course it’s only important to discuss the general assumptions we make when estimating the semi-variogram.</p>
<p>For a stationary and isotropic random process, we can estimate <span class="math inline">\(\tilde{\gamma}(h)\)</span> at distance <span class="math inline">\(h&gt;0\)</span> as follows:</p>
<ol type="1">
<li><p>Find all pairs of sites with a distance similar to <span class="math inline">\(h\)</span>. This gives the set <span class="math inline">\(\mathcal{N}_h =\{(i,j):||\mathbf{s}_i - \mathbf{s}_j||\approx h\}\)</span>.</p></li>
<li><p>Calculate the estimate for <span class="math inline">\(\tilde\gamma(h)\)</span> as [ (h) = _{(i,j) _h} (x_i-x_j)^2. ]</p></li>
</ol>
<p>The R package <strong>gstat</strong> provides the function <strong>variogram()</strong> to perform the estimation. We will see, however, in the following examples that some data wrangling is required.</p>
</section><section id="analysis-of-sea-surface-temperature-anomalies" class="level3"><h3 class="anchored" data-anchor-id="analysis-of-sea-surface-temperature-anomalies">Analysis of sea surface temperature anomalies</h3>
<p>The first step is to remove any locations with missing data (represented by <strong>NA</strong>) from the data frame - we have no data for land areas and the variogram() function cannot handle such data sets:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SSTA_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span> <span class="va">SSTA</span>, <span class="va">Anomaly</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Before we can use the variogram() function, we have to carefully consider whether all our key assumptions are reasonable:</p>
<dl>
<dt><strong><span class="math inline">\(\mathbb{E}\left[X(\mathbf{s})\right]\)</span> is constant across <span class="math inline">\(\mathcal{S}\)</span>:</strong></dt>
<dd>
<p>Since we consider anomalies, i.e., deviations from the mean, we may assume that the mean anomaly is 0 (or at least very close to it) for all locations in the North Sea.</p>
</dd>
<dt><strong>Dependence only depends on spatial distance:</strong></dt>
<dd>
<p>Figure @ref(fig:SST) shows a similar level of variability in the values of close-by sites for all areas of the North Sea. While this is not a sufficient condition, there is no clear reason for us to reject the assumption.</p>
</dd>
</dl>
<p>Now that we verified that our assumptions are not unreasonable, we are ready to estimate the semi-variogram for the random field <span class="math inline">\(\{X(\mathbf{s}):\mathbf{s}\in\mathcal{S}\}\)</span>. The first step is to convert the data frame <strong>SST_gamma</strong> to make it clear that the spatial locations are specified by their latitude and longitude coordinates:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://edzer.github.io/sp/reference/coordinates.html">coordinates</a></span><span class="op">(</span> <span class="va">SSTA_gamma</span> <span class="op">)</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">lon</span><span class="op">+</span><span class="va">lat</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can now use the variogram() function to calculate and plot the estimated function <span class="math inline">\(\hat\gamma(h)\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/">gstat</a></span><span class="op">)</span></span>
<span><span class="va">gamma_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html">variogram</a></span><span class="op">(</span> <span class="va">Anomaly</span><span class="op">~</span><span class="fl">1</span>, <span class="va">SSTA_gamma</span>, width<span class="op">=</span><span class="fl">0.1</span>, cutoff<span class="op">=</span><span class="fl">2</span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">gamma_hat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">dist</span>, y<span class="op">=</span><span class="va">gamma</span><span class="op">/</span><span class="fl">2</span> <span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> size<span class="op">=</span><span class="fl">2</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Distance"</span>, y<span class="op">=</span><span class="st">"Semi-variogram"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Estimated semi-variogram for sea surface temperature anomalies in the North Sea based on the data for 1 November 2024.</figcaption></figure>
</div>
</div>
</div>
<p>From the plotted semi-variogram we conclude that the dependence between pairs of sites decreased with increasing spatial distance. It’s also important to consider whether the function levels off at some distance, which would indicate independence at large spatial distances. This seems not to be the case here, and thus observations are dependent even at a distance of <span class="math inline">\(h=2\)</span>.</p>
<p><strong>Remark:</strong> The options and in the variogram function() specify the size of <span class="math inline">\(\mathcal{N}_h\)</span> and the maximum distance <span class="math inline">\(h\)</span> to be considered in the estimation.</p>
</section></section><section id="principal-component-analysis" class="level2"><h2 class="anchored" data-anchor-id="principal-component-analysis">Principal Component Analysis</h2>
<p>In many applications, interest lies in identifying the key data structures and to perform dimension reduction. There exists a range of techniques, such as cluster analysis, in data science and machine learning to achieve this. To conclude our trip through the world of point-referenced data, we introduce <strong>principal component analysis</strong> (PCA) and illustrate how it may be used to explore the spatial structure in the data. You may learn more about this technique in the Year 3 unit Applied Data Science.</p>
<section id="motivation-2" class="level3"><h3 class="anchored" data-anchor-id="motivation-2">Motivation</h3>
<p>Let’s consider a toy example with two sites and <span class="math inline">\(T\)</span> data points for each site. We use <span class="math inline">\(x_{i,t}\)</span> to denote the observation for site <span class="math inline">\(i\in\{1,2\}\)</span> on day <span class="math inline">\(t\in\{1,\ldots,T\}\)</span>. For illustration, we simulate some data with <span class="math inline">\(T=200\)</span> and visualize it using a scatter plot:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span> <span class="fl">200</span>, mean<span class="op">=</span><span class="fl">2</span>, sd<span class="op">=</span><span class="fl">4</span> <span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span> <span class="fl">200</span>, mean<span class="op">=</span><span class="va">x1</span>, sd<span class="op">=</span><span class="fl">1</span> <span class="op">)</span></span>
<span><span class="va">X</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span> <span class="st">"Site1"</span><span class="op">=</span><span class="va">x1</span>, <span class="st">"Site2"</span><span class="op">=</span><span class="va">x2</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">X</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Site1</span>, y<span class="op">=</span><span class="va">Site2</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Data for Site 1"</span>, y<span class="op">=</span><span class="st">"Data for Site 2"</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/ToyExample-1.png" class="img-fluid figure-img" style="width:38.0%"></p>
<figcaption>Toy data set with two spatial sites and 200 observations per site.</figcaption></figure>
</div>
</div>
</div>
<p>We can see that the simulated data is positively correlated, with most of the points lying close to the line <span class="math inline">\(y=x\)</span>. Principal component analysis is concerned with finding these important directions in cases where we have many variables / a large number of spatial sites.</p>
<p>In this course, we focus on deriving these directions as they give insight into the spatial structure of the data. Another important aspect of PCA, which we will not cover, is that of dimension reduction, which is particularly useful for modelling. For the data above, we may use PCA to project the two-dimensional data onto a one-dimensional subspace, which is illustrated below.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" style="width:38.0%"></p>
<figcaption>Original data (black) and the data points projected onto a one-dimensional linear subspace using PCA (red).</figcaption></figure>
</div>
</div>
</div>
<p>We won’t cover the mathematical background on PCA, and more details will be covered in the Year 3 Applied Data Science unit.</p>
</section><section id="analyzing-spatial-structure" class="level3"><h3 class="anchored" data-anchor-id="analyzing-spatial-structure">Analyzing spatial structure</h3>
<p>Suppose we have <span class="math inline">\(T\)</span> observations <span class="math inline">\(x_{i,1},\ldots,x_{i,T}\)</span> for the <span class="math inline">\(i\)</span>-th site with location <span class="math inline">\(\mathbf{s}_i\)</span> (<span class="math inline">\(i=1,\ldots,n\)</span>), and that <span class="math inline">\(x_{1,t},\ldots,x_{n,t}\)</span> (<span class="math inline">\(t=1,\ldots,T\)</span>) are recorded at the same time. We have to perform the following steps which are done in one go by the R function <strong>prcomp()</strong>:</p>
<ol type="1">
<li><p>Calculate <span class="math inline">\(\tilde{x}_{i,t} = (x_{i,t} - \bar{x}_i)/\hat\sigma_i\)</span>, where [ {x}_i = ] denotes the average value for the observations at the location <span class="math inline">\(\mathbf{s}_i\)</span>, and <span class="math inline">\(\hat\sigma_i\)</span> is the sample standard deviation.</p></li>
<li><p>Given the vectors <span class="math inline">\(\left\{\tilde{\mathbf{x}}_t =(\tilde{x}_{1,t},\ldots,\tilde{x}_{n,t}):t=1,\ldots,T \right\}\)</span>, we derive the matrix [ = _{t=1}^T _t _t^{}. ] This matrix is also known as the <strong>empirical covariance matrix</strong>, and it is a multivariate extension of the covariance covered in Year 1 Probability and Statistics.</p></li>
<li><p>Derive the eigenvalues and eigenvectors of <span class="math inline">\(\Sigma\)</span>, i.e., we are seeking the matrix <span class="math inline">\(\mathbf{U}\)</span> of eigenvectors and the diagonal matrix <span class="math inline">\(\mathbf{D}\)</span> of eigenvalues <span class="math inline">\(\lambda_1,\ldots,\lambda_n\)</span> such that <span class="math inline">\(\Sigma = \mathbf{UDU}^{\mathrm{T}}\)</span>.</p></li>
</ol>
<p><strong>How do we use the eigenvectors and eigenvalues to analyze the structure in the spatial data?</strong></p>
<ol type="1">
<li><p>We visualize the eigenvectors using the techniques covered so far. Each entry of an eigenvector corresponds to one of the sites and we study their spatial structure, starting from the eigenvector with the largest eigenvalue.</p></li>
<li><p>We use the eigenvalues <span class="math inline">\(\lambda_1,\ldots,\lambda_n\)</span> to determine how many eigenvectors we need to explore. The eigenvalues are ordered, i.e., <span class="math inline">\(\lambda_1 &gt; \lambda_2 &gt; \cdots &gt; \lambda_n\)</span>. For each <span class="math inline">\(m=1,\ldots,n\)</span>, we compute the ratio <span class="math display">\[\begin{equation}
\frac{\sum_{j=1}^m \lambda_j}{\sum_{j=1}^n \lambda_j}.
(\#eq:Ratio)
\end{equation}\]</span> We then look for the first value of <span class="math inline">\(m\)</span> for which the ratio exceeds 0.9. This corresponds to these <span class="math inline">\(m\)</span> components explaining at least 90% of the variation in the data. This is a widely used rule-of-thumb in PCA.</p></li>
</ol>
<p><strong>Important:</strong> For the eigenvalues and eigenvectors to accurately reflect the spatial structure, we have to make the assumption of <strong>linearity</strong>. This means that for any <span class="math inline">\(i=1,\ldots,n\)</span>, we can approximate <span class="math inline">\(X_{i,t}\)</span> by a linear combination of the (<span class="math inline">\(n-1\)</span>) remaining variables <span class="math inline">\(X_{1,t},\ldots,X_{i-1,t},X_{i+1,t},\ldots,X_{n,t}\)</span>.</p>
<p>PCA may seem very abstract at this point, but the following example with illustrate how to use it in practice.</p>
</section><section id="example-precipitation-across-colorado-united-states" class="level3"><h3 class="anchored" data-anchor-id="example-precipitation-across-colorado-united-states">Example: Precipitation across Colorado, United States</h3>
<p>The file “PrecipitationColorado.csv” contains the amount of precipitation per month for 30 cities in the state and the period 2010-2023. So we have <span class="math inline">\(n=30\)</span> sites and <span class="math inline">\(T=168\)</span> observations per site.</p>
<p>Let’s import the precipitation data and the information on the spatial sites.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ColoradoPrecip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/PrecipitationColorado.csv"</span> <span class="op">)</span></span>
<span><span class="va">ColoradoCities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Cities Colorado.csv"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Before we perform PCA, we have to consider the assumption of linearity, which can be difficult to verify in practice. In this example it is sufficient to just plot the data for pairs of sites against each other and to see whether there is a linear pattern</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">ColoradoPrecip</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">VALDEZ</span>, y<span class="op">=</span><span class="va">WETMORE</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">ColoradoPrecip</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">TOWNER</span>, y<span class="op">=</span><span class="va">STONINGTON</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">ColoradoPrecip</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">CARDIFF</span>, y<span class="op">=</span><span class="va">NORTHGLENN</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" style="width:95.0%"></p>
<figcaption>Scatter plots of the observed amounts of precipitation for three pairs of sites</figcaption></figure>
</div>
</div>
</div>
<p>There is clearly some positive correlation between all pairs of sites and so we can conclude that linearity is a reasonable assumption. So we can now proceed with the analysis and use the R function prcomp() to perform the computations in Section<a href="Analyzing spatial structure">4.4.2</a>. This function requires the data to be in a <span class="math inline">\(T\times n\)</span> matrix and thus we first have to remove the column <strong>date</strong> before calling prcomp():</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Precip</span> <span class="op">&lt;-</span> <span class="va">ColoradoPrecip</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span> <span class="op">-</span><span class="va">date</span> <span class="op">)</span></span>
<span><span class="va">PCA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span> <span class="va">Precip</span>, scale. <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span> <span class="co">## Combines all 3 steps</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The object <strong>PCA</strong> contains the computed eigenvalues and eigenvectors:</p>
<ul>
<li><p><strong>sdev</strong> - square roots of the eigenvalues.</p></li>
<li><p><strong>rotation</strong> - eigenvectors</p></li>
</ul>
<p>We now have to decide which eigenvectors should be visualized. The eigenvalues in <strong>sdev</strong> are ordered in terms of magnitude, i.e., the first eigenvectors are more important than the latter. So we are computing and visualizing the ratio @ref(eq:Ratio) for <span class="math inline">\(m=1,\ldots,30\)</span></p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ColoradoEV</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span> m<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, Ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">PCA</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">PCA</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">ColoradoEV</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">m</span>, y<span class="op">=</span><span class="va">Ratio</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span> intercept <span class="op">=</span> <span class="fl">0.9</span>, slope <span class="op">=</span> <span class="fl">0</span>, linewidth<span class="op">=</span><span class="fl">1.5</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" style="width:45.0%"></p>
<figcaption>Proportion of variance explained by the first m eigenvectors</figcaption></figure>
</div>
</div>
</div>
<p>The plot shows that the first three eigenvectors explain more than 90% of the variance in the data. Therefore, it is sufficient to visualize the first three eigenvectors, which we achieve by combining the values in the eigenvectors with the spatial sites:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ColoradoCities</span> <span class="op">&lt;-</span> <span class="va">ColoradoCities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span> PC1 <span class="op">=</span> <span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, PC2 <span class="op">=</span> <span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, PC3 <span class="op">=</span> <span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span> cols<span class="op">=</span><span class="va">PC1</span><span class="op">:</span><span class="va">PC3</span>, names_to<span class="op">=</span><span class="st">"PC"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Finally, we can plot the values of the first three eigenvectors using the visualizaion techniques we have seen before:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">ColoradoCities</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">LONG</span>, y<span class="op">=</span><span class="va">LAT</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span><span class="va">PC</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/stat_spatial_identity.html">geom_spatial_point</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">value</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">5</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"RdYlBu"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, color<span class="op">=</span><span class="st">"value"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/Colorado-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Illustration of the first three eigenvectors for the precipitation data from Colorado.</figcaption></figure>
</div>
</div>
</div>
<p>Now we have to interpret the plots:</p>
<ul>
<li><p>All entries in the first eigenvector have the same sign. This suggests that given monthly precipitation is high at one location, it also tends to be high at the other locations. We further observe a west-east trend in the values. Looking at the geography of Colorado, this direction likely represents the effect of the Rocky Mountains, which run through the western part of the state and stretch from north to south. As such, spatial variations in the amount of precipitation are driven by the different climates of Western and Eastern Colorado.</p></li>
<li><p>The second eigenvector shows a west-east trend. This may reflect again the effect of the Rocky Mountains on the spatial variation in the amount of precipitation.</p></li>
<li><p>The third eigenvector indicates a south-east to north-west trend across Colorado. Due to its size, there is quite a difference in climate between Northern and Southern Colorado. Northern Colorado tends to observe more snowfall in winter while Southern Colorado experiences more thunderstorms in the summer. So we may conclude that the third eigenvector captures this difference in climate</p></li>
</ul></section></section><section id="visualizing-point-pattern-data" class="level2"><h2 class="anchored" data-anchor-id="visualizing-point-pattern-data">Visualizing point pattern data</h2>
<p>Recall that the difference between point-referenced and point pattern data is that for the latter the points are randomly distributed across space, while they are fixed when analyzing point-referenced data. When visualizing point pattern data, there is no large difference to point-referenced data. This is due to both data types requiring us to add points (often provided by their latitude and longitude) to a shapefile or map.</p>
<p>We illustrate this aspect using the data in “Wildfires.csv”. The data file provides the locations of wildfires recorded for California between 2013 and 2020:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">WildFires</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Wildfires.csv"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s add the points in the Californian wildfire data set to a shapefile and a map, and also highlight the size of the burned area:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">USA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span> <span class="st">"Data/Shapefile USA/gadm41_USA_1.shp"</span> <span class="op">)</span></span>
<span><span class="va">California</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="va">USA</span>, <span class="va">NAME_1</span><span class="op">==</span><span class="st">"California"</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span>dTolerance <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">California</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">WildFires</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Longitude</span>,y<span class="op">=</span><span class="va">Latitude</span>, color<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">AcresBurned</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span> legend.position<span class="op">=</span><span class="st">"none"</span> <span class="op">)</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">WildFires</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> <span class="va">Longitude</span>, y<span class="op">=</span><span class="va">Latitude</span> <span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/stat_spatial_identity.html">geom_spatial_point</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">AcresBurned</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span>, color<span class="op">=</span><span class="st">"Log( Acres burned)"</span> <span class="op">)</span></span>
<span><span class="va">shape</span> <span class="op">+</span> <span class="va">map</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/Wildfires-1.png" class="img-fluid figure-img" style="width:85.0%"></p>
<figcaption>Locations of wildfires in California between 2013 and 2020 highlighting state boundaries (left) and with an underlying map (right). The size of the burned area is visualized using colour.</figcaption></figure>
</div>
</div>
</div>
<p>The plots highlight that there are areas of California that did not record any wildfires. A look on the map reveals that the south-east consists of the Mojave and Colorado Deserts and thus we would not expect to see wildfires there.</p>
</section><section id="intensity-of-a-point-process" class="level2"><h2 class="anchored" data-anchor-id="intensity-of-a-point-process">Intensity of a point process</h2>
<section id="motivation-3" class="level3"><h3 class="anchored" data-anchor-id="motivation-3">Motivation</h3>
<p>When analyzing point pattern data across a region <span class="math inline">\(\mathcal{S}\)</span>, we want to identify areas with a high density of points and explore possible reasons for the observed point patterns. For the wildfire data in Figure @ref(fig:Wildfires), we already found that some variation in the density of the points can be explained by the varied landscape and climate.</p>
<p>However, such conclusions may be difficult in some applications. Let’s consider a data set on tornadoes across the United States (excluding Alaska and Hawaii) between 1950 and 2021:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Tornadoes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Tornadoes.csv"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">Tornadoes</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> <span class="va">Lon</span>, y<span class="op">=</span><span class="va">Lat</span> <span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/stat_spatial_identity.html">geom_spatial_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/TORNADO-1.png" class="img-fluid figure-img" style="width:55.0%"></p>
<figcaption>Locations of tornadoes across the United States</figcaption></figure>
</div>
</div>
</div>
<p>From this plot we cannot identify where the most tornadoes occur. In such cases a common approach is to consider the <strong>intensity</strong> of the point process, which is directly related to the expected number of points over any subregion <span class="math inline">\(\mathcal{B}\subseteq\mathcal{S}\)</span>.</p>
<p><strong>Important:</strong> When working with point pattern data, both the number of points and their locations are random. For instance, we do not know how many wildfires will we observe and where they will occur.</p>
<p>Let’s formally define the intensity of a point process. For a subregion <span class="math inline">\(\mathcal{B}\subseteq\mathcal{S}\)</span>, we introduce the random variable <span class="math inline">\(N(\mathcal{B})\)</span> as the number of points of our sample that lie within <span class="math inline">\(\mathcal{B}\)</span>. The <strong>intensity function</strong> <span class="math inline">\(\lambda:\mathcal{S}\to\mathbb{R}_+=\{x\in\mathbb{R}:x\geq0\}\)</span> then describes the expectation of <span class="math inline">\(N(\mathcal{B})\)</span> with [ ({}) = = _{} () . ] When <span class="math inline">\(\lambda(\cdot)\)</span> is constant across <span class="math inline">\(\mathcal{S}\)</span>, we term the point process <strong>homogeneous</strong>. Otherwise, we call the point process <strong>non-homogeneous</strong>.</p>
<p>In what follows we describe two methods for visualizing the intensity: quadrat counting (Section <a href="#quadrat-counting">4.6.2</a>) and the kernel smoothed intensity function (Section <a href="#kernel-smoothed-intensity">4.6.3</a>). These plots may also help us to explore whether a process is homogeneous or non-homogeneous, but we will see that it is not straightforward.</p>
</section><section id="quadrat-counting" class="level3"><h3 class="anchored" data-anchor-id="quadrat-counting">Quadrat counting</h3>
<p>Let <span class="math inline">\(\mathbf{s}_1,\ldots,\mathbf{s}_n\in\mathcal{S}\)</span> denote the locations of the observed points. We then partition <span class="math inline">\(\mathcal{S}\)</span> into disjoint subregions <span class="math inline">\(\mathcal{B}_1,\ldots,\mathcal{B}_m\)</span>, with <span class="math inline">\(\bigcup_{j=1}^m \mathcal{B}_j = \mathcal{S}\)</span>, and count the number of points lying within each of them. This gives us an estimate <span class="math inline">\(\widehat{\mu(\mathcal{B}_j)}\)</span> for <span class="math inline">\(\mu(\mathcal{B}_j)~(j=1,\ldots,m)\)</span>, with <span class="math display">\[\begin{equation}
\widehat{\mu(\mathcal{B}_j)} = \sum_{i=1}^n \mathbb{I}\{\mathbf{s}_i \in \mathcal{B}_j\},
(\#eq:Quadrant)
\end{equation}\]</span> where <span class="math inline">\(\mathbb{I}\{\mathbf{s}_i \in \mathcal{B}_j\}=1\)</span> if <span class="math inline">\(\mathbf{s}_i \in \mathcal{B}_j\)</span> and <span class="math inline">\(\mathbb{I}\{\mathbf{s}_i \in \mathcal{B}_j\}=0\)</span> when <span class="math inline">\(\mathbf{s}_i \notin \mathcal{B}_j\)</span>. One common choice is to set <span class="math inline">\(\mathcal{B}_1,\ldots,\mathcal{B}_m\)</span> to rectangles or quadrats. This is why this approach is called <strong>quadrat counting</strong>.</p>
<p>If we assume that <span class="math inline">\(\lambda(\mathbf{s})\)</span> is constant for all <span class="math inline">\(\mathbf{s}\in\mathcal{B}_j\)</span>, we can estimate the value of <span class="math inline">\(\lambda(\mathbf{s})~(\mathbf{s}\in\mathcal{B}_j)\)</span> as <span class="math display">\[\begin{equation}
\hat{\lambda}^{(Q)}(\mathbf{s}) = \frac{\widehat{\mu(\mathcal{B}_j)}}{|\mathcal{B}_j|},
(\#eq:Quadrat)
\end{equation}\]</span> where <span class="math inline">\(|\mathcal{B}_j|\)</span> is the area of the subregion <span class="math inline">\(\mathcal{B}_j\)</span>.</p>
<p>When performing this approach, we have to balance two aspects:</p>
<ul>
<li><p><span class="math inline">\(\mathcal{B}_1,\ldots,\mathcal{B}_m\)</span> should be small enough such that <span class="math inline">\(\lambda(\mathbf{s})\)</span> is approximately constant for all <span class="math inline">\(\mathbf{s}\in\mathcal{B}_j\)</span></p></li>
<li><p><span class="math inline">\(\mathcal{B}_1,\ldots,\mathcal{B}_m\)</span> should be large enough such that <span class="math inline">\(\widehat{\mu(\mathcal{B}_j)}\)</span> in @ref(eq:Quadrant) provides a reliable estimate for <span class="math inline">\(\mu(\mathcal{B}_j)\)</span>.</p></li>
</ul>
<p>Let’s again consider the wildfire data set. While we may implement the approach from scratch, we us the <strong>spatstat</strong> R package. The first step is to combine the shapefile and observed points into a <strong>ppp</strong> object:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://spatstat.org/">spatstat</a></span><span class="op">)</span></span>
<span><span class="va">WildFires_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html">ppp</a></span><span class="op">(</span> <span class="va">WildFires</span><span class="op">$</span><span class="va">Longitude</span>, <span class="va">WildFires</span><span class="op">$</span><span class="va">Latitude</span>,</span>
<span>                      poly <span class="op">=</span> <span class="va">California</span><span class="op">$</span><span class="va">geometry</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We now use the <strong>quadratcount()</strong> function and compare results for two choices for the number of subregions:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span> mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, mai<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.5</span>,<span class="fl">0.01</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">WildFireQuadrants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/quadratcount.html">quadratcount</a></span><span class="op">(</span> <span class="va">WildFires_ppp</span>, nx<span class="op">=</span><span class="fl">2</span>, ny<span class="op">=</span><span class="fl">2</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">WildFireQuadrants</span> <span class="op">)</span></span>
<span><span class="va">WildFireQuadrants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/quadratcount.html">quadratcount</a></span><span class="op">(</span> <span class="va">WildFires_ppp</span>, nx<span class="op">=</span><span class="fl">6</span>, ny<span class="op">=</span><span class="fl">6</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">WildFireQuadrants</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/quadrat-1.png" class="img-fluid figure-img" style="width:90.0%"></p>
<figcaption>Quadrat counting estimates based on a 2x2 grid (left) and a 6x6 grid (right).</figcaption></figure>
</div>
</div>
</div>
<p>The plots indicate that the highest intensities are observed close to San Francisco and in the south-west, close to the Mexican border. We may argue that setting <span class="math inline">\(m=4\)</span> is too small as we cannot identify a clear structure, while the <span class="math inline">\(6\times6\)</span> grid offers a good balance between the two aspects outlined above. Due to the large differences in the estimated intensities, we may conclude that the point process is non-homogeneous.</p>
<p><strong>Important:</strong> The quadratcount() function counts the number of points, but does not calculate the intensity. So we would need to divide by the size of the subregions to obtain <span class="math inline">\(\hat{\lambda}^{(Q)}(\cdot)\)</span>.</p>
</section><section id="kernel-smoothed-intensity" class="level3"><h3 class="anchored" data-anchor-id="kernel-smoothed-intensity">Kernel smoothed intensity</h3>
<p>Our second method for exploring the intensity of a point process is based on the concept of density plots we studied in Section [2.2.4][Histograms and density plots]. Given a probability density function (kernel) <span class="math inline">\(K\)</span>, we define the kernel smoothed intensity estimate for <span class="math inline">\(\lambda(\mathbf{s})\)</span>, <span class="math inline">\(\mathbf{s}\in\mathcal{S}\)</span>, as <span class="math display">\[\begin{equation}
\hat\lambda^{(K)}(\mathbf{s}) = \sum_{i=1}^{n} K\left(||\mathbf{s}-\mathbf{s}_i||_2\right),
(\#eq:SKI)
\end{equation}\]</span> where <span class="math inline">\(||\mathbf{s}-\mathbf{s}_i||_2\)</span> denotes the Euclidian distance of <span class="math inline">\(\mathbf{s}\)</span> and <span class="math inline">\(\mathbf{s}_i\)</span>. The difference to Section [2.2.4][Histograms and density plots] is that <span class="math inline">\(K\)</span> is the density of a random vector and not of a random variable.</p>
<p>The estimate <span class="math inline">\(\hat{\lambda}^{(K)}\)</span> defined in equation @ref(eq:SKI) satisfies [ _{^2} ^{(K)}() = n. ] However, we may have <span class="math inline">\(\int_{\mathcal{S}} \hat{\lambda}^{(K)}(\mathbf{s}) \mathrm{d}\mathbf{s} \neq n\)</span>, because <span class="math inline">\(\hat{\lambda}^{(K)}(\mathbf{s})\)</span> may be positive outside the region <span class="math inline">\(\mathcal{S}.\)</span> This is also referred to as the <strong>edge effect bias</strong>, because it is usually caused by points that lie close to the boundary of <span class="math inline">\(\mathcal{S}\)</span>.</p>
<p>This leads to the <strong>uniformly corrected kernel smoothed intensity function</strong> [ ^{(C)}() = _{i=1}^{n} K(||-_i||<em>2), g() = </em>{} K(-) . ] This alternative estimate corrects for the edge effect bias.</p>
<p>There are multiple choices for the kernel <span class="math inline">\(K\)</span> and the correction, but we will limit our analysis to <span class="math inline">\(\hat\lambda^{(K)}\)</span> and <span class="math inline">\(\hat\lambda^{(C)}\)</span>, because they are the default settings for the <strong>density.ppp()</strong> function in the spatstat R package:</p>
<p><strong>Example:</strong> Let’s consider the Californian wildfire data set again, and we want to compare the two estimates <span class="math inline">\(\hat\lambda^{(K)}\)</span> and <span class="math inline">\(\hat\lambda^{(C)}\)</span>. We can directly apply the density.ppp() function to the ppp object we computed earlier:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lambdaK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/density.ppp.html">density.ppp</a></span><span class="op">(</span> <span class="va">WildFires_ppp</span>, edge<span class="op">=</span><span class="cn">FALSE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">lambdaK</span>, main<span class="op">=</span><span class="st">"Uncorrected"</span> <span class="op">)</span></span>
<span><span class="va">lambdaC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/density.ppp.html">density.ppp</a></span><span class="op">(</span> <span class="va">WildFires_ppp</span>, edge<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">lambdaC</span>, main<span class="op">=</span><span class="st">"Corrected"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Uncorrected (left) and corrected (right) kernel smoothed intensity for Californian wildfires.</figcaption></figure>
</div>
</div>
</div>
<p>The range of values in the legend shows that the estimates for <span class="math inline">\(\lambda^{(C)}\)</span> are higher than for <span class="math inline">\(\lambda^{(K)}\)</span> due to the correction and we also see some differences in the colour pattern close to the boundaries. Further, the spatial structure is similar to that of <span class="math inline">\(\hat{\lambda}^{(Q)}\)</span> in Figure @ref(fig:quadrat) - so we again conclude that the point process describing the occurrence of wildfires is non-homogeneous.</p>
<p><strong>Remark:</strong> Similar to density plots we can also introduce the notion of bandwidth in equation @ref(eq:SKI). We can manually set the bandwidth in the density.ppp() function using the argument <strong>sigma</strong>, with a smaller value leading to the kernels being more concentrated around the observed locations, as the following plot illustrates:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lambda_sigma0.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/density.ppp.html">density.ppp</a></span><span class="op">(</span> <span class="va">WildFires_ppp</span>, edge<span class="op">=</span><span class="cn">TRUE</span>, sigma <span class="op">=</span> <span class="fl">0.1</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">lambda_sigma0.1</span>, main<span class="op">=</span><span class="st">"sigma=0.1"</span> <span class="op">)</span></span>
<span><span class="va">lambda_sigma10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/density.ppp.html">density.ppp</a></span><span class="op">(</span> <span class="va">WildFires_ppp</span>, edge<span class="op">=</span><span class="cn">TRUE</span>, sigma <span class="op">=</span> <span class="fl">10</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">lambda_sigma10</span>, main<span class="op">=</span><span class="st">"sigma=10"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Corrected kernel smoothed intensity estimates for Californian wildfires with sigma=0.1 (left) and sigma=10 (right).</figcaption></figure>
</div>
</div>
</div>
<p>Note, both of these choices for the bandwidth are poor. A bandwidth of <span class="math inline">\(\sigma=0.1\)</span> gives a too strong concentration, with wildfires predicted with very high probability at the same locations as the observed fires. On the other hand, a bandwidth of <span class="math inline">\(\sigma=10\)</span> leads to the estimated intensity function being smoothed too much over space, with all areas of California predicted to have a similar risk of wildfires, which is in contrast to our previous findings.</p>
</section><section id="tornadoes-across-the-united-states" class="level3"><h3 class="anchored" data-anchor-id="tornadoes-across-the-united-states">Tornadoes across the United States</h3>
<p>Let’s return to the example in Figure @ref(fig:TORNADO). While there is a strong indication that the point process is non-homogeneous, we need to analyze the data in more detail. We start by again loading the data</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Tornadoes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Tornadoes.csv"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>There are a total of 68663 tornadoes in the data set. In the next Section <a href="#visualizing-lattice-data">4.7</a> we will count the number of storms per state and visualize the extracted numbers. Here we focus on the states of Kansas and Texas and estimate the intensity function. For this, we first need to load a shapefile for the USA, which includes the state boundaries:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">USA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span> <span class="st">"Data/gadm41_USA_shp/gadm41_USA_1.shp"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>When analyzing the California wildfire data, we created the ppp object using the largest polygon in the shapefile. However, this may not be ideal in all cases, in particular, when we are working with multiple islands. Here we introduce an alternative approach for constructing the ppp object, which performs better in cases where we want to include the full shapefile.</p>
<p>The first step is to extract the shapefiles for Kansas and Texas from the shapefile for the USA, reduce their complexity and then change the projection (<strong>we cannot use the WGS84 coordinate system here</strong>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">KS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="va">USA</span>, <span class="va">NAME_1</span><span class="op">==</span><span class="st">"Kansas"</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span> dTolerance <span class="op">=</span> <span class="fl">2000</span> <span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span> crs<span class="op">=</span><span class="fl">3857</span> <span class="op">)</span></span>
<span><span class="va">TX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="va">USA</span>, <span class="va">NAME_1</span><span class="op">==</span><span class="st">"Texas"</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span> dTolerance <span class="op">=</span> <span class="fl">2000</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span> crs<span class="op">=</span><span class="fl">3857</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we have to transform the observed locations of Tornadoes to the same coordinate system as the shapefiles:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Tornadoes_transformed</span> <span class="op">&lt;-</span> <span class="va">Tornadoes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span> coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Lon"</span>,<span class="st">"Lat"</span><span class="op">)</span>, crs<span class="op">=</span><span class="fl">4326</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span> crs<span class="op">=</span><span class="fl">3857</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Finally, we create the ppp objects for Kansas and Texas:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Texas_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html">ppp</a></span><span class="op">(</span> <span class="va">Tornadoes_transformed</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">Tornadoes_transformed</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, </span>
<span>                  window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.owin.html">as.owin</a></span><span class="op">(</span><span class="va">TX</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">Kansas_ppp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.html">ppp</a></span><span class="op">(</span> <span class="va">Tornadoes_transformed</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="va">Tornadoes_transformed</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>                   window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.owin.html">as.owin</a></span><span class="op">(</span><span class="va">KS</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Remark:</strong> The warning messages we received are due to not all tornadoes we observed being located in these states.</p>
<p>Having converted the data to a ppp object, we derive and plot the corrected kernel smoothed intensity function:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lambdaC_KS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/density.ppp.html">density.ppp</a></span><span class="op">(</span> <span class="va">Kansas_ppp</span>, edge<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">lambdaC_KS</span>, main<span class="op">=</span><span class="st">"Kansas"</span> <span class="op">)</span></span>
<span><span class="va">lambdaC_TX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/density.ppp.html">density.ppp</a></span><span class="op">(</span> <span class="va">Texas_ppp</span>, edge<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span> <span class="va">lambdaC_TX</span>, main<span class="op">=</span><span class="st">"Texas"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Corrected smoothed kernel intensity for the occurrence of tornadoes across Kansas and Texas.</figcaption></figure>
</div>
</div>
</div>
<p>While the intensity values are very small, there are clear conclusions we can draw from the plots. For Texas, the intensity is much higher in the north and east than along the border to Mexico. So it’s reasonable to conclude that the point process describing tornadoes across Texas is non-homogeneous. When comparing the results of Texas and Kansas, the peak intensities are comparable, but Kansas shows less variance in the values of the intensity function. Consequently, we may argue that the point process describing the locations of tornadoes across Kansas is homogeneous.</p>
<p><strong>Important:</strong> When discussing whether a point process is homogeneous or not, we also have to consider whether the locations of points depend on each other. For instance for wildfires, this may correspond to the probability of a wildfire being dependent on whether wildfires occurred recently and in close proximity. It’s presumably fine to assume that tornadoes occur independently of each other, and thus our conclusions are reasonable. However, in other cases we may be unable to make such conclusions as the techniques we covered in this course do not allow us to distinguish between whether (a) the point process is non-homogeneous and (b) the point process is homogeneous but dependent. In these cases we need to account for the context of the study.</p>
</section></section><section id="visualizing-lattice-data" class="level2"><h2 class="anchored" data-anchor-id="visualizing-lattice-data">Visualizing lattice data</h2>
<p>When working with lattice data we have to plot values for a fixed number of areas instead of a fixed number of points. These areas are usually defined by shapefiles. We will consider two examples to demonstrate how to visualize lattice/areal data using shapefiles.</p>
<section id="population-density-across-london-boroughs" class="level3"><h3 class="anchored" data-anchor-id="population-density-across-london-boroughs">Population density across London boroughs</h3>
<p>Suppose we have observations which refer to the different boroughs of London, such as average income for each borough. Let’s load the shapefiles for the boroughs (and the City of London):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">London</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"Data/London.shp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span> <span class="va">London</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sf"         "tbl_df"     "tbl"        "data.frame"</code></pre>
</div>
</div>
<p>We see that the object <strong>London</strong> consists of: (1) a <strong>sf</strong> part which includes the data to produce the shapefiles and (2) a data frame to store the information for each borough. The information provided in the data frame includes, for instance, area size in hectares.</p>
<p>We want to explore and visualize the population density in 2020. For this we import the data on the number of residents in 2020 for each borough provided in the file “London.csv”. We load the population data and create a new variable which represents population density in the data frame of the object <strong>London</strong></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">London_population</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/London.csv"</span> <span class="op">)</span></span>
<span><span class="va">London_population</span> <span class="op">&lt;-</span> <span class="va">London_population</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span> Population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"\\,"</span>,<span class="st">""</span>,<span class="va">Population</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">London</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">London</span>, y<span class="op">=</span><span class="va">London_population</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NAME"</span><span class="op">=</span><span class="st">"Borough"</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">London</span> <span class="op">&lt;-</span> <span class="va">London</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span> Density <span class="op">=</span> <span class="va">Population</span> <span class="op">/</span> <span class="va">HECTARES</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>To visualize the calculated population densities, we have two options:</p>
<ol type="1">
<li><p>Use color as a visual cue</p></li>
<li><p>Place points within the boroughs, with their size depending on the density</p></li>
</ol>
<p>Let’s create both options:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">London</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">Density</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span> axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span>, axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Population density in people per hectare for the 33 London boroughs.</figcaption></figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> data<span class="op">=</span><span class="va">London</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> data<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">London</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span> size <span class="op">=</span> <span class="va">Density</span>, geometry <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>, </span>
<span>              stat <span class="op">=</span> <span class="st">"sf_coordinates"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span> axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span>, axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: st_centroid assumes attributes are constant over geometries</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Population density for the 33 London boroughs, with size of points used as visual cure.</figcaption></figure>
</div>
</div>
</div>
<p>We see that Central London (with the exception of the City of London) records the highest population densities. The outer boroughs tend to have a population density between 40 and 80 people per hectare.</p>
<p><strong>Remark:</strong> When we download shapefiles from gadm.org, we can get the different administrative levels and assign values in the same way. We will demonstrate this in the next example.</p>
</section><section id="tornadoes-across-the-united-states-1" class="level3"><h3 class="anchored" data-anchor-id="tornadoes-across-the-united-states-1">Tornadoes across the United States</h3>
<p>We want to visualize the number of tornadoes for each US state in the continental United States. Let’s load the data from “Tornadoes.csv” and extract the number of tornadoes for each state between 1950 and 2021:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Tornadoes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span> <span class="st">"Data/Tornadoes.csv"</span> <span class="op">)</span></span>
<span><span class="va">TornadoesNumbers</span> <span class="op">&lt;-</span> <span class="va">Tornadoes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span> <span class="va">State</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We then load the shapefile and combine it with the extracted number of tornadoes:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">USA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"Data/gadm41_USA_shp/gadm41_USA_1.shp"</span><span class="op">)</span></span>
<span><span class="va">USA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_simplify</a></span><span class="op">(</span> <span class="va">USA</span>, dTolerance <span class="op">=</span> <span class="fl">5000</span>, preserveTopology <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="va">USA</span><span class="op">$</span><span class="va">HASC_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span> <span class="st">".*\\."</span>, <span class="st">""</span>, <span class="va">USA</span><span class="op">$</span><span class="va">HASC_1</span><span class="op">)</span></span>
<span><span class="va">USA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span> <span class="va">USA</span>, <span class="va">TornadoesNumbers</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HASC_1"</span><span class="op">=</span><span class="st">"State"</span><span class="op">)</span> <span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Remark:</strong> The third line of code is necessary because the states in <strong>TornadoesCount</strong> are represented as “TX”, “KS”, etc., but these abbreviations do not exist in <strong>USA</strong>. Therefore, we change the entries <strong>HASC_1</strong> column to use it for combining the data frames.</p>
<p>For this analysis we Alaska and Hawaii from the analysis as we have no data for it. The observations can be removed using the filter function and we rename some of the variables:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">USA</span> <span class="op">&lt;-</span> <span class="va">USA</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span> <span class="op">!</span><span class="va">NAME_1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span><span class="op">)</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span> State <span class="op">=</span> <span class="va">NAME_1</span>, Number<span class="op">=</span><span class="va">n</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can now plot the data as we did in the example considering the data for London. We make one addition and also add a map to the plot using the ggspatial R package:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span> <span class="va">USA</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">Number</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html">annotation_map_tile</a></span><span class="op">(</span> zoom<span class="op">=</span><span class="fl">5</span> <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_fill_distiller</a></span><span class="op">(</span> palette<span class="op">=</span><span class="st">"Reds"</span>, trans<span class="op">=</span><span class="st">"reverse"</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span> fill<span class="op">=</span><span class="st">"Number"</span>, x<span class="op">=</span><span class="st">"Longitude"</span>, y<span class="op">=</span><span class="st">"Latitude"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span> axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span>, axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="04-SpatialDataAnalysis_files/figure-html/TornadoesUSA-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Number of tornadoes for each state in the continential US for 1950-2021.</figcaption></figure>
</div>
</div>
</div>
<p>Using the map we conclude that the highest number of tornadoes occur in Texas, Oklahoma, Kansas and Florida, while the Western United States observes a relatively small number of tornadoes.</p>
</section></section><section id="summary" class="level2"><h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this chapter we considered the analysis of spatial data:</p>
<ul>
<li><p>There are three types of spatial data: point-referenced, point pattern and lattice</p></li>
<li><p>All types of spatial data can be visualized using shapefiles (using the <strong>sf</strong> package) and/or maps (using <strong>ggspatial</strong>). In these cases we often have to resort to colour as a visual cue.</p></li>
<li><p>When the data covers a large spatial area/region, we should carefully select the projection we use for our shapefiles</p></li>
<li>
<p>When working with point-referenced data, we can</p>
<ul>
<li><p>Employ inverse distance weighting to make predictions at unobserved sites</p></li>
<li><p>Estimate the semi-variogram or perform principal component analysis to analyse spatial dependence</p></li>
<li><p>Use principal component analysis to analyze the spatial structure in the data</p></li>
</ul>
</li>
<li><p>Quadrat counting and kernel intensity function for analyzing point pattern data;</p></li>
</ul>
<p>These techniques allow us to explore features of the spatial data and are essential for developing models for spatial data - these models are however too complex to be fully considered in a Year 2 unit. Some of them will be covered in MA32024 Statistical Modelling and Data Analytics 3B.</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../lecture_notes/03-Text-Data-Analysis.html" class="pagination-link" aria-label="Text Data Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Text Data Analysis</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../slides.html" class="pagination-link" aria-label="Slides">
        <span class="nav-page-text">Slides</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2025, University of Bath</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>


</body></html>