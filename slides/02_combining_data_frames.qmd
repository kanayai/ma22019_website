---
title: "Combining data frames"
subtitle: "Lecture"
date: "12 February 2025"
---



## Plan for Today

So far we have analyzed a single complex data frame using the dplyr R package.

Today we explore 

- how we can combine multiple data frames (Section 1.3)

- the elements of a plot (Sections 2.1.1 and 2.1.2)

- visualizing data using ggplot2 (Section 2.2)


# Combining Data Sets

## Motivation

Let's revisit the river flow data for Bathford

```{r, warning=FALSE, message=FALSE, echo=TRUE}
library(dplyr)
library(lubridate)
Bathford <- read.csv("data/bathford_river_flow.csv",
    skip = 20, header = FALSE,
    colClasses = c("character", "numeric", "NULL")
) %>%
    rename(Date = V1, RiverFlow = V2) %>%
    mutate(Date = as_date(Date, format = "%Y-%m-%d"))
glimpse(Bathford)
```

## Reporting Missing Data

When we work with real-world data, we have to check whether data are missing.

If there is missing data, you should report the amount of missing data!

```{r, echo=TRUE}
Bathford %>%
    summarize("Proportion Missing" = mean(is.na(RiverFlow)))
```

We see that river flow is missing for about 0.6% of days.



## Combining data sets with dplyr

**How can we add data from other gauges to the data frame?**

The dplyr package offers four functions to combine data frames based on matching values, which we call the "key(s)".

- inner_join()

- full_join()

- left_join()

- right_join()

The functions differ in terms of observations kept.


## Example - Loading the data

Let's load the river flow data for another gauge:
```{r, echo=TRUE, warning=FALSE}
Bath <- read.csv("data/bath_river_flow.csv",
    skip = 19, header = FALSE,
    colClasses = c("character", "numeric", "NULL")
)
Bath <- Bath %>%
    rename(Date = V1, RiverFlow = V2) %>%
    mutate(Date = as_date(Date, format = "%Y-%m-%d"))
glimpse(Bath)
```


## Example - Comparing the data sets

Let's check the first elements of each data set

```{r, echo=TRUE}
slice_head(Bath, n = 2)
slice_head(Bathford, n = 2)
```

**What do we notice?**


## Example - Merging the data sets 


Let's merge observations based on **Date**

```{r, echo=TRUE}
RF <- full_join(Bathford, Bath, by = c("Date" = "Date"))
slice_head(RF, n = 1)
```



We see that the variable names need updating:

```{r, echo=TRUE}
RF <- rename(RF, Bathford = RiverFlow.x, Bath = RiverFlow.y)
```


## Example - Data analysis

We explore dependence of the river flow levels

```{r, fig.align='center', out.width='80%', echo=FALSE}
plot(RF$Bath, RF$Bathford,
    pch = 19,
    xlab = "River Flow at Bath", ylab = "River Flow at Bathford"
)
```


## Comparison with inner_join()

While full_join() keeps all observation, inner_join() only keeps the dates listed in both data sets

```{r, echo=TRUE}
RF <- inner_join(Bathford, Bath, by = c("Date" = "Date"))
slice_head(RF, n = 3)
```

## Remarks 


- left_join() and right_join()



- Combining a large number of data sets <br> -> **for loop** (Section 1.3.2)



- Order of elements after merging

```{r, echo=TRUE}
RF <- full_join(Bath, Bathford, by = c("Date" = "Date"))
slice_head(RF, n = 1)
```



## Key Messages

We have now finished the chapter on **Data Wrangling**. The take-home messages are

* Ensure that variables are of the correct type and use informative variable names

* Use the dplyr package to structure and manipulate your data

* The restructuring process should be determined by the research question

* Check for missing data and report the proportion if data are missing

