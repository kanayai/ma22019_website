---
title: "Analysis of NRFA Data"
date: "12/02/2025"
format: html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading the data and R packages 

```{r, warning=FALSE, message=FALSE}
library( lubridate )
library( dplyr )
```

```{r}
Bathford <- read.csv("bathford_river_flow.csv", skip=20, header=FALSE,
                      colClasses = c("character","numeric","NULL") ) 
```

## Data Cleaning

Check which variables need to converted and renamed

```{r}
glimpse( Bathford )
```

### Change variables names

```{r}
Bathford <- rename( Bathford, Date = V1, RiverFlow = V2 )
```

### Convert to correct type

```{r}
Bathford$Date <- as_date( Bathford$Date, format="%Y-%m-%d" )
```


## Data Wrangling and visualization

### Proportion of missing data

```{r}
mean( is.na( Bathford$RiverFlow ) )
```

### Plot river flow over time

```{r, out.width='60%', fig.height=4, fig.width=6, fig.align='center'}
plot( Bathford$Date, Bathford$RiverFlow, type='l',
      xlab="Date", ylab="River Flow", cex.lab = 1.5 )
```

### Filter observations based on date and observed river flow

```{r}
Bathford_High <- filter( Bathford, RiverFlow > 100 )
slice_head( Bathford_High, n=5 )
```

```{r}
Bathford_High <- filter( Bathford, RiverFlow > 100, year(Date) > 1990 )
slice_head( Bathford_High, n=5 )
```

### Loading data for a second gauge at Bath

```{r, echo=TRUE, warning=FALSE}
Bath <- read.csv("bath_river_flow.csv", skip=19, header=FALSE,
                  colClasses = c("character","numeric","NULL") )
Bath <- Bath %>% rename( Date = V1, RiverFlow = V2 ) %>%
  mutate( Date = as_date( Date, format="%Y-%m-%d" ) )
glimpse( Bath )
```

We note that the gauge at Bath started recording river flow a few years after the gauge at Bathford.

This prevents us from analyzing the dependence in the river flow of the two students, for instance, using the covariance (introduced in Year 1 Probability & Statistics):

```{r}
#| error: true
cov(Bath$RiverFlow, Bathford$RiverFlow)
```





## Merging the two data sets

Let's merge observations based on **Date** and rename the variables

```{r, echo=TRUE}
RF <- full_join( Bathford, Bath, by=c("Date" = "Date") ) %>%
  rename( Bathford = RiverFlow.x, Bath = RiverFlow.y )
slice_head(RF, n=5)
```

First observations for Bath are missing, since the gauge was not operational at that time.

## Data analysis

Let's explore the dependence of the river flow levels for the two gauges:

```{r, out.width='50%', fig.height=5, fig.width=5, fig.align='center'}
plot( RF$Bath, RF$Bathford, pch=19,
      xlab="River Flow at Bath", ylab="River Flow at Bathford" )
```


We can now calculate the covariance and correlation

```{r}
cov( RF$Bathford, RF$Bath,  use = "complete" )
cor( RF$Bathford, RF$Bath,  use = "complete" )
```

## Comparison with inner_join()

While full_join() keeps all observation, inner_join() only keeps the dates listed in both data sets

```{r, echo=TRUE}
RF <- inner_join( Bathford, Bath, by=c("Date" = "Date") )
slice_head(RF, n=5)
```
