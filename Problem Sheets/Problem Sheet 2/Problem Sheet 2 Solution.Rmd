---
title: "MA22019 2025 - Solutions for Problem Sheet 2"
author: "Working with dplyr and ggplot2"
output:
  html_document: default
  pdf_document: default
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### **Overview**

Exercises 1-3 help you with revising the techniques covered in the lectures in Week 2 (and Sections 1.3-2.2 in the lecture notes). You can check your solutions to these questions yourself by entering them on Moodle.

The tutorial questions ask you to apply functions from the dplyr, lubridate and ggplot2 packages. You should prioritize Tutorial Question 1, and only after completing it consider Tutorial Questions 2 and 3. Please make sure to use R Markdown for all your analyses.

Your answer to the Homework Question can be submitted on Moodle to your tutor for feedback. The submission deadline is 17:00 on Thursday 20 February 2025. You should submit a single Word, PDF or HTML file that provides your R code, any created R output and all your comments.

Before starting the questions, please make sure to load the relevant R packages: 

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(lubridate)
library(ggplot2)
library(patchwork)
```

### **Exercise 1 - Identifying visual cues**

An analysis of the Australian weather data, considered in the lecture, produced the following plot:

```{r, echo=F, out.width='83%', fig.height=3, fig.width=7, fig.align='center'}
AUS      <- read.csv("WeatherAustralia.csv" )
AUS$Date <- as_date( AUS$Date, format="%d/%m/%Y" )
MS       <- filter( AUS, Location %in% c("Darwin","Sydney") )
ggplot( MS, aes( x=Date, y=Rainfall ) ) + facet_wrap(~Location) +
  geom_step( aes(linetype=Location, colour=Location) ) +
  labs( y="Amount of Rainfall")
```

Identify the visual cues used in the plot and submit your answers via the quiz on Moodle.

<p style="color:blue">*One may argue that the following visual cues have been used:*</p>

* <p style="color:blue">**Position** *to indicate whether observations are earlier or later in the year.*</p>

* <p style="color:blue">**Length** *to facilitate a comparison between days*.</p>

* <p style="color:blue">**Colour** *and* **shape** *(line type) to separate the two cities*.</p>


### **Exercise 2 - Temperatures for Rio de Janeiro and Sao Paulo**

The files "Rio Temperature.csv" and "Sao Paulo Temperature.csv" contain monthly average temperature measurements for Rio de Janeiro and Sao Paulo in Brazil. Missing values in the data matrix are stored as $\mathrm{\texttt{NA}}$. 

a) Join the temperature data for Sao Paulo and Rio de Janeiro into a single data frame using full_join(). Each row in this new data frame should provide the year, month and the monthly average temperatures for Rio de Janeiro and Sao Paulo. Rename any variables that have uninformative names.

<p style="color:blue">*We first load the two data sets:*</p>

```{r}
Rio <- read.csv( "Rio Temperature.csv" )
SaoPaulo <- read.csv( "Sao Paulo Temperature.csv" )
```

<p style="color:blue">*We then apply full_join() to merge the two data sets, and data points are to be merged based on both year and month:*</p>

```{r}
Temperature <- full_join( SaoPaulo, Rio, by=c("YEAR"="YEAR", "MONTH"="MONTH") )
```

<p style="color:blue">*The variable names for the temperature values are uninformative, and we replace them with the names of the cities:*</p>

```{r}
Temperature <- Temperature %>%
  rename( "SaoPaulo" = TEMPERATURE.x, "Rio" = TEMPERATURE.y )
```

b) Using the data frame produced in part a), answer the following two questions and submit your answers via the quiz on Moodle:

(i) What was the monthly average temperature for Rio de Janeiro when Sao Paulo recorded its highest monthly average temperature?
  
<p style="color:blue">*One way is to sort the data based on the temperature for Sao Paulo and to then extract the first entry: *</p>
  
```{r}
Temperature %>%
  arrange( desc(SaoPaulo) ) %>%
  slice_head( n=1 )
```

<p style="color:blue">*So the answer we are looking for is 28.95 degree Celsius.*</p>
  

(ii) What was the largest difference in the monthly average temperatures for Sao Paulo and Rio de Janeiro?
    
<p style="color:blue">*We first calculate the absolute value of the difference for each month with mutate and then use summarise() to find that the maximum value of this new variable is 5.44: *</p>
    
```{r}
Temperature %>%
  mutate( Difference = abs( SaoPaulo - Rio ) ) %>%
  summarise( "Maximum Difference" = max( Difference, na.rm = TRUE ) )
```
    



### **Exercise 3 - Weather in New York City in 2019**

The file "NYC Weather 2019.csv" provides daily weather data for 2019 for New York City. We are given the following variables:

* **Date:** Day of the recording

* **Tmin, Tmax:** Minimum and maximum temperature in degree Fahrenheit

* **Precipitation:** Amount of precipitation in inches

Consider the following tasks. You can submit your answers to parts c) and e) via the quiz on Moodle.

a) Create a density plot to visualize the distribution of the maximum daily temperature.

<p style="color:blue">*Let's first load the data*</p> 

```{r}
NYC <- read.csv( "NYC Weather 2019.csv" )
```

<p style="color:blue">*We then use the functions ggplot() and geom_density() introduced in the lecture:*</p> 

```{r, fig.align='center', out.width='45%', fig.height=4, fig.width=6}
ggplot( NYC, aes( x=Tmax ) ) + 
  geom_density() + labs( x="Maximum daily temperature in Fahrenheit" )
```


b) Similar to Section 2.2.3. in the lecture notes, create a line plot of day of year against amount of precipitation on that day.

<p style="color:blue">*An inspection of the data shows that we need to convert the variable* **Date** *to its correct type*</p> 

```{r}
NYC <- NYC %>% mutate( Date = as_date( Date, format="%d/%m/%Y") )
```

<p style="color:blue">*We can now use ggplot2 to create a line plot. We can use either geom_line() or geom_col() in this case:*</p> 

```{r, fig.align='center', out.width='50%', fig.height=4, fig.width=6}
ggplot( NYC, aes( x=Date, y=Precipitation ) ) + 
  geom_col() + labs( y="Precipitation in inches" )  
```



c) Identify the date for which the difference in recorded daily minimum and maximum temperatures was at its highest in 2019. Enter your answer in the Day/Month format via the quiz on Moodle.

<p style="color:blue">*We first create a new variable which represents the difference in minimum and maximum temperature on the day:*</p> 

```{r}
NYC <- NYC %>% mutate( Difference = Tmax - Tmin )
```

<p style="color:blue">*To pinpoint the date, we use functions from the dplyr package:*</p>

```{r}
NYC %>%
  arrange( desc(Difference) ) %>%
  slice_head( n=1 )
```

<p style="color:blue">*We find that highest average difference in daily minimum and maximum temperature for 2019 occurred in July.*</p>


d) Create a plot which per month provides a box plot for the maximum daily temperature. **Hint:** Use the function month() to extract the month from a date and then apply the function factor() to convert it to a categorical variable.

<p style="color:blue">*The first step is to create a new variable in the data frame which represents the month of the observation. We apply the functions mentioned in the question text as follows:*</p>

```{r}
NYC <- NYC %>% mutate( Month = factor( month(Date) ) )
```

<p style="color:blue">*We then use the function geom_boxplot() from the lecture to produce for each momth a boxplot for the daily maximum temperature:*</p>

```{r, fig.align='center', out.width='60%', fig.height=4, fig.width=6}
ggplot( NYC, aes(x=Month,y=Tmax) ) + geom_boxplot() + 
  labs( x="Month", y="Maximum daily temperature in Fahrenheit" )
```  


e) Answer the following two questions and submit your questions via the quiz on Moodle:

(i) Which month had the highest median daily maximum temperature according to your plot in part d)?

<p style="color:blue">*Since the box plot visualizes, amongst others, the median value, we conclude that July recorded the highest median in terms of daily maximum temperature.*</p>

(ii) We learned that box plots should usually be ordered based on a criteria, such as the median. Should this approach also be taken for the box plot you created in part d)?

<p style="color:blue">*No, it's better to keep the plot as it is presented in part d). In general, we should not reorder the categorical variables when they are ordinal, i.e., when there is a logical ordering to them. Another example would be star ratings - in this case we also should not change the order of the variables. For the example above, not changing the order of the months makes it, for instance, easier to visualize seasonal effects.*</p>



### **Tutorial Question 1 - Utopia's Ambulance Service**

The health department of *Utopia* has collected data on the response time of their ambulance service, including whether patients were admitted to the country's hospitals and how long they stayed. All the data are stored across the files "Ambulance.csv" and "Hospital.csv". The variables in "Ambulance.csv" are

* **Call** -  Day and time at which the ambulance service was notified

* **Category** - Ambulance response category (1=”Life threatening”, 4=”non-urgent”)

* **Arrival** -  Time of arrival of the ambulance at the patient's location

* **PatientID** -  Health insurance number of the patient

* **Hospital** -  Time patient arrived at the hospital (missing values indicate that no hospitalization was required)

The file "Hospitals.csv" provides the following information:

* **PatientID** -  Health insurance number of the patient

* **Age** - Age of the patient

* **Length** - Number of days the patient stayed in hospital

We are asked by the Utopian government to perform an analysis which only considers the patients who were brought to hospital by the ambulance service. For these patients, they ask us to address the following two questions:

a) When considering patients within the different response categories, are there any differences in terms of time spent in hospital?

<p style="color:blue"> *The first step is to load the two data sets:*</p> 

```{r}
Ambulance <- read.csv("Ambulance.csv")
Hospitals <- read.csv("Hospital.csv") 
```

<p style="color:blue"> *Since the analysis focuses on the patients admitted to hospital, we combine the two data sets using inner_join() and use the patient ID as the key:*</p>

```{r, warning=FALSE, message=TRUE}
Patients <- inner_join( Ambulance, Hospitals, by="PatientID" )
```

<p style="color:blue"> *We may then, for instance, use box plots to compare the distribution of length of stay across the different ambulance categories. One tricky bit is that we first need to convert the numerical value for* **Category** *into a categorical variable, either using factor() or case_when():*</p>

```{r}
Patients <- Patients %>%
  mutate( Category = case_when( Category==1 ~ "Category 1",
                                Category==2 ~ "Category 2",
                                Category==3 ~ "Category 3",
                                Category==4 ~ "Category 4" )
        )
```

<p style="color:blue"> *We are now ready to create the box plots:*</p>

```{r, fig.align='center', out.width='40%', fig.width=5, fig.width=5}
ggplot( Patients, aes( x=Category, y=Length ) ) + 
  geom_boxplot() + theme_bw() +
  labs(x="Ambulance Category", y="Length of Hospital Stay")
```

<p style="color:blue"> *We see that expected length of stay increases with the level of emergency. The longest hospital times are observed for category 1, life-threatening conditions, with a median time of about 12 days, while the median length of stay for non-urgent cases is 6 days.*</p>

b) What is the relation between a patient's waiting time for the ambulance and their length of stay in hospital? **Hint:** You may want to consult the lubridate cheat sheet to help with converting dates to their correct type.

<p style="color:blue"> *The first step is to convert all the variables representing times to their correct type. This can, for instance, be achieved using the function ymd_hms() from the lubridate R package:*</p> 

```{r}
Patients <- Patients %>% mutate( Call=ymd_hms(Call), Arrival=ymd_hms(Arrival) ) 
```

<p style="color:blue"> *The next step is to extract the time the patient had to wait for the ambulance. We have seen that R can compute differences in time and you may use the time difference directly. It's also not wrong to convert the difference in dates to numerical values, which we can achieve using as.numeric():*</p> 

```{r}
Patients <- Patients %>% mutate( Wait=as.numeric(Arrival-Call) )
```


<p style="color:blue"> *Now we are ready to create adequate plots to address the question. Here we will use scatter plots and geom_smooth(), as we want to explore the relation between two variables. We have to consider the different categories separately, as the seriousness of the situation will have an impact on how waiting time affects health outcomes:*</p> 

```{r, fig.align='center', out.width='70%'}
ggplot( Patients, aes(x=Wait,y=Length) ) +
  facet_wrap( ~Category, scales="free_x" ) + 
  geom_point() + geom_smooth() + theme_bw()
```

<p style="color:blue"> *We see that the length of stay tends to increase with the length of wait for ambulance categories 1 and 2. For the most urgent category, a waiting time beyond 20 minutes leads to an increase in the average length of stay. For Category 2, waiting times should be kept below 50 minutes, as the average length of stay in hospital tends to be longer for patients who have to wait more than this. We also see a small effect for Category 3, but the response time seems to have very little influence on the length of stay for non-urgent cases. This does of course not mean we should feel comfortable with keeping these patients waiting for days.*</p> 


### **Tutorial Question 2 - 2021/22 UEFA Champions League**
  
The files "UEFA goals.csv" and "UEFA attacking.csv" contain all the player stats on goals and assists for the UEFA Champions League season 2021-22. Use the data to extract the following information:

a) Which two teams scored the most goals in the 2021/22 UEFA Champions League? How many goals did they score?

<p style="color:blue">*We start by loading the two data sets: *</p>

```{r}
Goals <- read.csv( "UEFA goals.csv" )
Assists <- read.csv( "UEFA attacking.csv" )
```

<p style="color:blue">*For the first question we only need to consider goals, and we aggregate the goals of the individual players according to their club:*</p>

```{r}
Goals %>% 
  group_by( club ) %>%
  summarise( "Total" = sum(goals) ) %>%
  arrange( desc(Total) ) %>%
  slice_head( n=2 )
```
  
<p style="color:blue">*We find that Bayern Munich and FC Liverpool are the two clubs who scored the most goals (30 each).*</p>  
  
b) When ranking attackers, the sum of goals and assists is a widely used metric. Extract the top 10 players in terms of this metric. **Hint:** Not every player in the data recorded at least one goal and one assist. 

<p style="color:blue">*We now need to combine the player statistics for goals and assists. To avoid merging two players with the same surname, we also use club and position as variables to be considered when merging the data frames*</p>  

```{r}
Players <- full_join( Goals, Assists, by=c("player_name", "club", "position") )
```

<p style="color:blue">*The next step is to replace any NA by 0. This can, for instance, be achieved with case_when():*</p> 

```{r}
Players <- Players %>%
  mutate( goals = case_when( goals == NA ~ 0, .default = goals ),
          assists = case_when( assists == NA ~ 0, .default = assists ) )
```

<p style="color:blue">*We are now ready to calculate the score for each player*</p> 

```{r}
Players <- Players %>%
  select( player_name, club, goals, assists ) %>%
  mutate( score = goals + assists )
```

<p style="color:blue">*Finally, we rank players based on their score and print the top 10 players in a table:*</p> 

```{r}
Players %>%
  arrange( desc(score) ) %>%
  slice_head( n=10 )
```

### **Tutorial Question 3 - Working with discrete variables**

When plotting values of discrete variables (such as number of sales) some information may not be visible because points may lie on top of each other. We will explore how the functions **geom_count()** and **geom_jitter()** facilitate handling such situations.

NOAA in the United States has recorded 332 billion-dollar natural disasters between 1980 and 2022, that is, each event caused overall damages in excess of $1 billion US dollars. The types of natural disasters include flooding, severe storms, droughts, etc. In this analysis we focus on the number of natural disasters per type and year and the data are provided in the file "US Billion Dollar Disasters.csv".

a) Create a scatter plot for number of flood events against severe storms per year. Discuss which information can be drawn from the plot?

<p style="color:blue">*We use the* **geom_point()** *function to create the scatter plot.*</p>

```{r, fig.align='center', out.width='40%', fig.height=4, fig.width=4}
Disasters <- read.csv( "US Billion Dollar Disasters.csv" )
ggplot( Disasters, aes(x=Flooding, y=SevereStorm) ) + geom_point() +
  labs( x="Number of floods", y="Number of severe storms" )
```

<p style="color:blue">*There is no clear pattern visible. The yearly numbers of floods and severe storms appear to be independent.*</p>

b) Replace the function geom_point() in part a) by geom_count(). Which conclusions can be drawn from this new plot?

<p style="color:blue">*The new plot is created using*</p>

```{r, fig.align='center', out.width='40%', fig.height=4, fig.width=4}
ggplot( Disasters, aes(x=Flooding,y=SevereStorm) ) + geom_count() + 
  labs( x="Number of floods", y="Number of severe storms" )
```

<p style="color:blue">*The new plot reveals that the number of floods is usually 0 or 1, and that there is a large number of years with 1 or 2 storms. This was not visible at all in the previous plot.*</p>

c) Replace the function geom_point() in part a) by geom_jitter(). What does this function do? Which conclusions can be drawn from this new plot?

<p style="color:blue">*The new plot is created using*</p>

```{r, fig.align='center', out.width='40%', fig.height=4, fig.width=4}
ggplot( Disasters, aes(x=Flooding,y=SevereStorm) ) + geom_jitter() + 
  labs( x="Number of floods", y="Number of severe storms" )
```

<p style="color:blue"> *The function* **geom_jitter()** *adds some random noise to each point to separate observations. The conclusions are equivalent to that in part b.*</p>



### **Homework Question - Optimizing growing conditions for orchids**

A research institute set up an experiment in 2024 to determine the best growing conditions for two types of Orchids: Cymbidium and Dendrobium. The design of the experiment was as follows:

* All orchids were planted in March or April 2024. Each individual orchid was exposed to constant temperature and phosphate levels, but levels differed across orchids. 

* The height (in inches) and quality of each orchid were measured on 20 October 2024. Plant quality was assessed using a score between 1 and 10 (1=very poor, 10=excellent). Any orchid with a score above 6 is considered of "good" quality.

The research institute approached us to analyze their collected data which provides:


* **Type** - Type of the orchid.

* **Height** - Height of the orchid on 22 October 2024.

* **Quality** - Quality as measured on 22 October 2024.

* **Phosphate** - The level of phosphate in ppm (parts per million) the orchid was exposed to since it had been planted.

* **Temperature** - The temperature (in degree Celsius) the orchid was exposed to since it had been planted.

* **Planting** - The date the orchid was planted.

The full data are provided in the file “Orchids.csv” and the research institute is interested in:

a) How do the two types of orchids compare in terms of the heights measured on 22 October 2024?

b) What are the effects of phosphate and temperature on the height of the orchids?

c) Did the date when the orchid was planted have any effect on whether their quality was at least "good" on 22 October 2024?

Perform an analysis which considers the three aspects above. Make sure to clearly state your approach and conclusions.

<p style="color:blue">*We start by loading the data:*</p>
  
```{r}
Orchids <- read.csv( "Orchids.csv" )
```

<p style="color:blue">*One approach to compare the heights is to create a box plot of height for each of the two types:*</p>
  
```{r, fig.align='center', out.width='40%', fig.height=5, fig.width=4}
ggplot( Orchids, aes("x"=Type, "y"=Height) ) + geom_boxplot() + 
  labs( "x"="Type of Ochid", "y" = "Height in inches" )
```

<p style="color:blue">*We find that the orchids are markedly different in terms of their heights. For Cymbidium, most of the plants had a height between 10 and 20 inches, while the plant height for Dendrobium was more varied, ranging from 17 and 35 inches. There are also other aspects one may comment on.*</p>
  
  
<p style="color:blue">*We now explore the relation between temperature/phosphate and plant height. Due to the large differences in height, this analysis is done separately for both types:*</p>
  
```{r, fig.align='center', out.width='60%', fig.height=4, fig.width=6}
ggplot( Orchids, aes(x=Phosphate, y=Height) ) + 
  facet_wrap(~Type) + geom_point() + geom_smooth() + 
  labs( "x"="Level of Phosphate", "y" = "Height in inches" )
```

```{r, fig.align='center', out.width='60%', fig.height=4, fig.width=6}
ggplot( Orchids, aes(x=Temperature, y=Height) ) + 
  facet_wrap(~Type) + geom_point() + geom_smooth() + 
  labs( "x"="Temperature", "y" = "Height in inches" )
```

<p style="color:blue">*We find that the average plant height seems to increase slightly with increasing temperature, and the same applies for phosphate.*</p>
  
  
<p style="color:blue">*For the final aspect, we want to explore whether the proportion of orchids of "good" quality varies across the different planting dates. For this we convert the variable* **Planting** *and define a binary variable to represent whether the quality was at least "good":*</p>
  
```{r}
Orchids <- Orchids %>% 
  mutate( Good = case_when( Quality>6 ~ 1 , Quality<7 ~ 0 ) ) %>%
  mutate( Planting = as_date( Planting, format="%Y-%m-%d" ) )
```

<p style="color:blue">*We now get an estimate for the proportion of "good" orchids relative to planting date, and we again consider the two types of orchid separately:*</p>
  
```{r, fig.align='center', out.width='60%', fig.height=4, fig.width=6}
ggplot( Orchids, aes( "x"=Planting, "y"=Good ) ) + 
  facet_wrap( ~Type ) + geom_smooth() + 
  labs( "x"="Date of planting", "y"="Proportion of good quality" )
```

<p style="color:blue">*Generally speaking, orchids planted in late March/ first half of April were more frequently of at least "good" quality than the orchid planted in early March or late April. There are also other aspects one may comment on.*</p>
