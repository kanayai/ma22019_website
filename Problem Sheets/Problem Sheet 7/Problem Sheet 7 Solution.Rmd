---
title: "MA22019 2025 - Solutions for Problem Sheet 7"
author: "Semi-variogram and principal component analysis"
output:
  html_document: default
  pdf_document: default
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### **Overview**

This week's problem sheet focuses on the methods for analyzing spatial dependence introduced in Sections 4.3 and 4.4 in the lecture notes. Exercises 1-2 help you with revising the content of the lecture in Week 8.

Tutorial Questions 1 and 2 each consider one of the two techniques we covered in Week 8. 

Your answer to the Homework Question can be submitted on Moodle to your tutor for feedback. The submission deadline is 17:00 on Thursday 3 April 2025. You should submit a single PDF or Word file that provides your R code, any created R output and all your comments.

You may want to load the following packages before starting the exercise:

```{r, message=FALSE, warning=FALSE}
library( dplyr )
library( lubridate )
library( ggplot2 )
library( tidyr )
library( sf )
library( ggspatial )
library( prettymapr )
library( sp )
library( gstat )
```

When working on a University PC, you will have to first install some of these packages. 



### **Exercise 1 - Exploring spatial structure in river flow data**

A data scientist used principal component analysis to explore the spatial structure / dependence in the daily maximum river flow values across 45 gauges in Northern England and the South of Scotland. They identified that the first 3 components explain more than 90% of the variation in the data and created the following plots representing the first three eigenvectors:

```{r, fig.align='center', out.width='100%', fig.width=12, fig.height=7, echo=FALSE, warning=FALSE, message=FALSE}
RF <- read.csv("River Flow.csv")
RF <- RF %>% na.omit() 
PCA <- prcomp( RF, scale. = TRUE )
Loc <- read.csv("Locations River Flow.csv")
Loc <- Loc %>%
  mutate( PC1 = PCA$rotation[,1], PC2 = PCA$rotation[,2], PC3 = PCA$rotation[,3] ) %>%
  pivot_longer( cols=PC1:PC3, names_to="PC" )
GB <- read_sf( "gadm41_GBR_shp (1)/gadm41_GBR_2.shp" )
GB <- GB %>% st_simplify( dTolerance = 500 )
ggplot( GB ) + geom_sf(fill="white") + theme_bw() +
  geom_point(data=Loc, aes(x=Lon,y=Lat,color=value), size=5 ) + 
  scale_color_distiller( palette="Blues" ) +
  xlim(-3.5,-1) + ylim(53,55.5) + 
  facet_wrap( ~PC ) +
  labs( x="Longitude", y="Latitude", color="value" )
```

Provide an interpretation for the three plots and then go to Moodle and complete the quiz.

* <p style="color:blue"> *All entries in the first eigenvector are positive. This indicates that given river flow is high at one site, it tends to be at all other gauges too.*</p>

* <p style="color:blue"> *The second eigenvector takes negatives values for sites located in Lake District, and more generally in the north-west of the study area. So this eigenvector indicates that there are differences between the gauges located in the Lake District (and sites to it) and the sites further south (around Manchester and Liverpool).*</p>

* <p style="color:blue"> *The third eigenvector shows a trend from the west to the east coast - it takes negative values for sites close to the west coast, while it is positive for the remaining sites. This eigenvector may represent how much the river flow at a gauge is influenced by weather moving in from a westerly direction.*</p>


### **Exercise 2 - Concentrations of zinc in the top soil**

The file "Meuse.csv" gives topsoil zinc concentrations (in mg/kg) collected across 155 locations in a flood plain of the river Meuse. Specifically, we are given

* Lon,Lat - Longitude and latitude coordinate of the locations

* Zinc - Zinc concentration on logarithmic scale

Perform the following steps to explore the spatial structure in the data:

a) Visualize the zinc concentration on logarithmic scale using the ggspatial package. What do you conclude?

<p style="color:blue"> *We start by loading the data:*</p>

```{r}
Meuse <- read.csv("Meuse.csv")
```

<p style="color:blue"> *We use the functions in the ggspatial package to visualize the data:*</p>

```{r, fig.align='center', out.width='65%', message=FALSE}
ggplot( Meuse, aes(x=Lon, y=Lat) ) + annotation_map_tile( zoom = 14 ) + 
  geom_spatial_point( aes(color=Zinc) ) + 
  scale_fill_distiller( palette="Reds", trans="reverse" ) +
  labs( x="Longitude", y="Latitude", color="Log(Zinc concentration)")
```

<p style="color:blue"> *We find that concentration tends to be higher for locations close to the river, while sites further away record lower values:*</p>


b) Explore the spatial dependence in the zinc concentration on logarithmic scale by estimating the semi-variogram for the data. Go to Moodle and answer the quiz.

<p style="color:blue"> *We first convert the data into spatial data points:*</p>

```{r}
Meuse_gamma <- Meuse
coordinates(Meuse_gamma) <- ~ Lon+Lat
```

<p style="color:blue"> *Now we can estimate and visualize the semi-variogram:*</p>

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
gamma_hat <- variogram( Zinc~1, Meuse_gamma, cutoff=0.015  )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
  theme_bw() + labs( x="Distance", y="Semi-variogram" )
```

<p style="color:blue"> *We find that semi-variogram increases with increasing spatial up to a distance of about 0.01, at which it starts to level off. From this we can conclude that spatial dependence decreases with increasing spatial distance, i.e. there is stronger dependence between spatially close sites than between locations that are far apart. Further, for sites that further than 0.01 apart, zinc concentrations are close to independent.*</p>

<p style="color:blue"> *One may argue whether it's reasonable to assume that dependence is fully described by the distance between sites, since we saw that distance from the river seems to be an important factor explaining variables. As such one may want to add an explanatory variable (such as distance to the river) to the analysis, but such an approach is beyond this unit (a suitable framework may be introduced in Statistics 3B).*</p>

### **Tutorial Question 1 - Spatial dependence in soil moisture**

The file "SoilMoisture.csv" contains soil moisture measurements for 1 July 2022 for the Iberian peninsula (i.e. Spain and Portugal). Data were collected using satellites and each point corresponds to the soil moisture recorded for an area of $0.25°\times 0.25°$. We want to visualize the data and estimate the semi-variogram:
  
a) Load the data into R and create a spatial plot which shows the soil moisture for each point, that is, the $x$ and $y$ axis should correspond to longitude and latitude respectively, with colour being used as a visual cue representing soil moisture. What do you conclude?
  
<p style="color:blue"> *We start by loading the data:*</p>
    
```{r}
Soil <- read.csv( "SoilMoisture.csv" )
```
  
<p style="color:blue"> *There are a few options for visualizing the data. One option is to use the function geom_tile() in the ggplot2 package:*</p>
    
```{r, fig.align='center', out.width='60%', fig.height=4, fig.width=5}
ggplot( Soil, aes(x = Longitude, y = Latitude, fill = Soil_Moisture) ) +
  geom_tile() + scale_fill_viridis_c() + theme_bw() +
  labs( x="Longitude", y="Latitude", fill="Soil Moisture" )
```
  
<p style="color:blue"> *We see that soil moisture on 1 July 2022 was lower in western Spain and southern Portugal than in southern and Eastern Spain. We also see that soil moisture is only changing slowly over space, with a few exceptions, such as in the north-west of the Iberian peninsula.*</p>
    
    
b) Remove any grid cells with missing data from the data set using the function na.omit(). Why is this step necessary for estimating the semi-variogram?
  
<p style="color:blue"> *We can directly apply the function to the data frame and any rows with missing values will be removed:*</p>
    
```{r}
Soil <- na.omit( Soil )
```
  
<p style="color:blue"> *There are two reasons for removing these data points from the analysis. Firstly, the function variogram() we are using to estimate the semi-variogram cannot deal with missing data. Secondly, missing values usually occur for the grid cells which correspond to the Atlantic Ocean or Mediterranean Sea, for which it does not make sense to measure soil moisture. The few missing values across the land may be due to the satellite being unable to measure soil moisture, for instance due to continuous cloud cover.*</p>
    
c) Estimate the semi-variogram using the function variogram() from the gstat R package. Visualize your estimate. What do you conclude?
  
<p style="color:blue"> *The first step is to convert the longitude and latitude variables into spatial coordinates:*</p>
    
```{r}
coordinates( Soil ) <- ~Longitude+Latitude
```
  
<p style="color:blue"> *We are now ready to estimate and visualize the semi-variogram:*</p>
    
```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
gamma_hat <- variogram( Soil_Moisture~1, Soil, width=0.2, cutoff=7  )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
theme_bw() + labs( x="Distance", y="Semi-variogram" )
```
  
<p style="color:blue"> *The estimated semi-variogram shows that spatial dependence decreases with spatial distance. We further see that the semi-variogram does not level off at large distances, which suggests that some dependence even exists at larger distances. This may be explained by soil moisture being dependent on the weather which tends to affect larger spatial regions.*</p>

d) Discuss whether it is reasonable to assume that the value of the semi-variogram is fully specified by the distance between spatial sites, which is the key assumption we make when using the variogram() function.

<p style="color:blue"> *Looking at the plot in part a), the assumption seems not unreasonable. While there are some areas where values change suddenly, for the vast majority of the Iberian peninsula, the values change slowly and there is little suggestion that theer is a directional affect.*</p>

<p style="color:blue"> *To explore this is a bit more, we split the data into two halfs - West and East - and compare the estimate semi-variograms. This is not a sufficient condition, but it allows for some more in-depth assessment of the assumption.*</p>

<p style="color:blue"> *We start by splitting the data based on Longitude:*</p>

```{r}
Soil <- read.csv( "SoilMoisture.csv" )
Soil_West <- filter(Soil, Longitude < -4 ) %>% na.omit( )
Soil_East <- filter(Soil, Longitude >= -4 ) %>% na.omit( )
```

<p style="color:blue"> *Next we estimate the semi-variogram for each of the two regions:*</p>

```{r}
coordinates( Soil_West ) <- ~Longitude+Latitude
gamma_West <- variogram( Soil_Moisture~1, Soil_West, width=0.1, cutoff=4  )

coordinates( Soil_East ) <- ~Longitude+Latitude
gamma_East <- variogram( Soil_Moisture~1, Soil_East, width=0.1, cutoff=4  )
```

<p style="color:blue"> *Let's plot the two semi-variograms in the same plot to compare them :*</p>

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
ggplot( gamma_West, aes( x=dist, y=gamma/2 ) ) + 
  geom_point( size=2, aes(color="West") ) + 
  geom_point( data=gamma_East, aes( x=dist, y=gamma/2, color = "East"), size=2 ) +
  theme_bw() + labs( x="Distance", y="Semi-variogram" ) + 
  scale_color_manual( values = c("black", "red"), name = "Region", breaks = c("West", "East") )
```

<p style="color:blue"> *There is a small difference between the two estimates, but it is not too large as to draw our conclusions into doubt, as we can see that the value of the semi-variogram increases with spatial distance - so we again conclude that dependence between sites gets weaker the further they are apart.*</p>



### **Tutorial Question 2 - Maximum monthly temperature across Germany**

The file "Temperature Germany.csv" contains maximum monthly temperatures recorded for 20 sites in the northern half of Germany for 2000-2023. The longitude and latitude coordinates for the sites can be found in the file "Sites Germany.csv". In the following we will visualize the data and analyse its spatial structure.

a) For all sites calculate their median monthly maximum temperature for June across the period 2000-2023. Create a plot to visualize the values you obtained. What do you conclude? 

<p style="color:blue"> *Let's first load the two data sets:*</p>

```{r}
Sites <- read.csv("Sites Germany.csv")
Temperature <- read.csv("Temperature Germany.csv")
```

<p style="color:blue"> *The first step is to calculate the median value for each site and we need to be aware that there are some missing values:*</p>

```{r}
Median_June <- Temperature %>%
  filter( month(Date) == 6 ) %>%
  group_by( Site ) %>%
  summarise( Median = quantile(Temperature, 0.5, na.rm = TRUE) )
```

<p style="color:blue"> *We can now attach the calculated values to the data frame with the locations of the sites:*</p>

```{r}
Sites <- Sites %>% full_join( Median_June, by="Site" )
```

<p style="color:blue"> *Now we are ready to plot the extracted values:*</p>

```{r, message=FALSE, out.width='70%', fig.height=5, fig.width=6, fig.align='center'}
ggplot( Sites, aes(x=Longitude, y=Latitude) ) + 
  annotation_map_tile( zoom=7 ) + 
  geom_spatial_point( aes(color=Median), size=3 ) + 
  labs( color="Temperature", title="Median monthly maximum temperature in June")
```

<p style="color:blue"> *We find that median monthly maximum temperature in June is lower along the coast (about 26 degree Celsius) than further inland (with temperature of 30 degree Celsius and above).*</p>


b) We now want to use principal component analysis to analyse the spatial structure in the data. One difference to the example from the lecture notes is that we standardize the data per month and site, rather than just per site. Formally, we standardize the data using
\[
\tilde{x}_{i,j,t} = (x_{i,j,t} - \bar{x}_{i,j})/\hat{\sigma}_{i,j},
\]
where $x_{i,j,t}$ is the maximum temperature for site $i$ in month $j$ and year $t$. We will have to perform this standardization "by hand" and can no longer rely on prcomp() to do it for us. Perform the following steps to perform PCA in this case and interpret your outputs:

    1. Standardize the data per site and month using the equation above.
  
    2. Use the pivot_wider() function to convert the data to a data frame such that each column contains the standardized observations for one side. Use the function na.omit() to remove any rows with missing data.

    3. Apply the prcomp() function using the values obtained in Step 2.
    
    4. Using the eigenvalues, decide on the number $m$ of eigenvectors we should study.
    
    5. Visualize the first $m$ eigenvectors, where $m$ is the number you decided on in part Step 4. What do you conclude?
  
<p style="color:blue"> *For Step 1 we need to group observation based on site and month and then scale the data for each subset:*</p>

```{r}
Temperature <- Temperature %>%
  group_by( Site, Month=month(Date) ) %>%
  mutate( Temp_Scaled = ( Temperature - mean(Temperature, na.rm = TRUE)) /
            sd(Temperature, na.rm=TRUE) ) %>%
  ungroup()
```

<p style="color:blue"> *To obtain a matrix as we require for PCA, we need to turn the single column with the standardized temperatures to separate columns for the different sites. We can achieve using pivot_wider():*</p>

```{r}
Temperature_wide <- Temperature %>%
  select( Date, Site, Temp_Scaled ) %>%
  pivot_wider( names_from = Site, values_from = Temp_Scaled )
```

<p style="color:blue"> *What is left is to remove any variables that don't correspond to a site and to remove any rows with missing values:*</p>

```{r}
Temp_PCA <- Temperature_wide %>%
  select(-Date) %>%
  na.omit()
```

<p style="color:blue"> *Now we are ready to calculate the empirical covariance matrix and to derive the eigenvectors and eigenvalues:*</p>

```{r}
PCA <- prcomp( Temp_PCA )
```

<p style="color:blue"> *To find the number of eigenvector we should consider, we are looking for the smallest* $m$ *such that at least 90% of the structure are explained. One way to find this value is plotting* $m$ *against the ratio considered in the lectures:*</p>

```{r, fig.align='center', out.width='45%', fig.height=3.5, fig.width=5}
TempEV <- data.frame( m=1:20, Ratio = cumsum(PCA$sdev^2) / sum(PCA$sdev^2) )
ggplot( TempEV, aes(x=m, y=Ratio) ) + geom_point() + 
  geom_abline( intercept = 0.9, slope = 0, linewidth=1.5 ) + 
  theme_bw() + labs(x="Number m of eigenvectors")
```

<p style="color:blue"> *We find that the first three eigenvectors help to explain slightly above 90% of the structure and we thus we visualize these three:*</p>

```{r , fig.align='center', out.width='100%', fig.width=12, fig.height=4, message=FALSE}
Sites <- Sites %>%
  mutate( PC1 = PCA$rotation[,1], PC2 = PCA$rotation[,2], PC3 = PCA$rotation[,3] ) %>%
  pivot_longer( cols=PC1:PC3, names_to="PC" )

ggplot( Sites, aes( x=Longitude, y=Latitude) ) + 
  facet_wrap( ~PC ) +
  annotation_map_tile() + 
  geom_spatial_point( aes(color=value), size=5 ) + 
  scale_color_distiller( palette="RdYlBu" ) +
  labs( x="Longitude", y="Latitude", color="value" )
```

<p style="color:blue"> *The plots can be interpreted as follows:*</p>

* <p style="color:blue"> *The plot of the first eigenvector shows that all entries are positive. Consequently, this eigenvector suggests that temperatures exceeding the average for the month are often observed across all sites.*</p>

* <p style="color:blue"> *The second eigenvector shows a north-west to south-east trend. This eigenvector may represent exposure to the weather coming from the North Sea.*</p>

* <p style="color:blue"> *The third eigenvector shows a north-east to south-west trend. This may reflect that very high temperatures in western Germany are often due to weather pattern across Western Europe, while these have less influence on the weather close to the Baltic Sea.*</p>

### **Homework Question - Spatial dependence in temperatures across Brazil**

Let's again consider the temperature data from Brazil considered in Problem Sheet 6. The data are provided in the file "Brazil Temperature.csv". In the following we want to explore the spatial dependence in the data.

a) Estimate the semi-variogram for the data. What do you conclude about the spatial dependence in the observed temperatures?

<p style="color:blue"> *We estimate the semi-variogram using the variogram() function and then plot it:*</p>

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
Brazil <- read.csv( "Brazil Temperature.csv" )
coordinates( Brazil ) <- ~Lon+Lat
gamma_hat <- variogram( MeanTemp~1, data = Brazil, width=0.5 )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
  theme_bw() + labs( x="Distance", y="Semi-variogram" )
```

<p style="color:blue"> *The semi-variogram function seems to increase with increasing spatial distance. This suggests that the sptail dependence in the average temperature decreases with increasing spatial distance. Further, the function does not seem to flatten out, which corresponds to even sites are larger spatial dependence still showing some level of dependence.*</p>

b) Discuss whether it is reasonable to assume that the spatial random process has a constant mean and that the value of the semi-variogram is fully specified by the distance between spatial sites.

<p style="color:blue"> *Let's create a plot of the data:* </p>

```{r, warning=FALSE, message=FALSE, fig.align='center', out.width='70%'}
Temperature <- read.csv( "Brazil Temperature.csv" )

ggplot( Temperature, aes( x=Lon, y=Lat ) ) + 
  annotation_map_tile( zoom=5 ) + 
  geom_spatial_point( aes(color=MeanTemp), size=2 ) +
  scale_color_distiller( palette="Reds", trans="reverse" ) +
  labs( x="Longitude", y="Latitude", color="Mean Daily Temperature" )
```

* <p style="color:blue"> **Constant mean:** *This seems questionable since we would expect that some areas have higher average temperatures than others. For instance, sides closer to the sea may be exposed to a different climate than sites further inland. This is also visible in the plot above.*</p>

* <p style="color:blue"> **Non-stationarity and isotropy:** *This is a bit hard to assess due to the potential issue with the constant mean assumption. A simple check is to pick a couple of different areas across and assess whether (1) the difference in values of spatially close sites is similar and (2) whether the pattern in differences is comparable and not influenced by direction. Both of these points appear not unreasonable and thus we may conclude that the assumption holds that the semi-variogram is fully specified by the distance between spatial sites (when ignoring the constant mean issue). However, one may argue that there may be a directional affect related to exposure to the weather from the sea.*</p>


c) **Bonus:** One may argue that the constant mean assumption may not hold for the spatial process $\{X(\mathbf{s}) : \mathbf{s}\in\mathcal{S}\}$. The variogram() function allows us to define a model of the form
\begin{equation}
X(\mathbf{s}) = \beta_0  + \beta_1\mathrm{Longitude}(\mathbf{s}) + \beta_2\mathrm{Latitude}(\mathbf{s}) + Z(\mathbf{s}),
\end{equation}
where $\{Z(\mathbf{s}) : \mathbf{s}\in\mathcal{S}\}$ is termed the residual random process. The semi-variogram estimated by the variogram() function then corresponds to that for the residual random process. In R, we derive and visualize this estimate using

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
Brazil <- read.csv( "Brazil Temperature.csv" )
coordinates( Brazil ) <- ~Lon+Lat
gamma_hat <- variogram( MeanTemp ~Lon+Lat, data = Brazil, width=0.5 )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
  theme_bw() + labs( x="Distance", y="Semi-variogram" )
```

Describe the similarities and differences between this estimate and yours in part a). Discuss whether the conclusions we draw regarding spatial dependence in the residual process are the same as for the process in part a).   

**Remark:** You may learn more about the type of models in Equation (1) in Statistical Modelling & Data Analytics 3B.

<p style="color:blue"> *Both estimates for the semi-variogram function show that their values increase with increasing spatial distance. As such, spatial dependence in the average temperature seems to decrease with increasing spatial distance in both cases. One important difference is that the semi-variogram function for the residual process is flat from a distance of about 2, while this is not the case when considering the semi-variogram in part a). Consequently, observations of the residual process are close to independent when sites are further than a distance of 1.5-2.5 apart. We also see a difference in the values of the semi-variogram, especially for larger distances, but this observation does not really provide more insight.*</p>

<p style="color:blue"> *To summarize, there is a difference in the conclusions drawn from the two approaches in parts a) and c). Specifically, the approach in part c) somewhat accounts for the mean not being constant for all sites and thus we may argue that the results in part c) are more representative and better capture the actual process.*</p>

