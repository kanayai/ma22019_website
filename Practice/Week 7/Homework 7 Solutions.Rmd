---
title: "MA22019 2025 - Solutions for Homework 7"
author: "Visualization of point-referenced data and inverse distance weighting"
output:
  html_document: default
  pdf_document: default
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

You may want to load the following packages before starting the exercises:

```{r, message=FALSE, warning=FALSE}
library( dplyr )
library( ggplot2 )
library( sf )
library( ggspatial )
library( prettymapr )
```


## **Homework Question - Lead concentration across Amaurot**

The local authorities in Amaurot, the capital of Utopia, have seen an alarming increase in lead concentration levels in the drinking water. They thus collected samples on lead concentration across the city. The data on the recorded lead levels and the spatial coordinates are provided in the file "Amaurot Lead.csv".

The local authorities have now approached you to help them tackle the issue. They provided you with the collected data and a shapefile of Amaurot. To hide Amaurotâ€™s location, the latitude and longitude coordinates have been manipulated, but the provided shapes are correct. You are asked to perform the following tasks:

a) Visualize the measured lead concentrations. What do you conclude?

<p style="color:blue">*We start by loading the patient data and the shapefile*</p>

```{r}
Patients <- read.csv( "data/Amaurot Lead.csv" )
Amaurot <- read_sf( "Shapefiles/Amaurot.shp" )
```

<p style="color:blue">*Combining the shapefile with the data allows us to visualize the recorded lead levels:*</p>

```{r, fig.align='center', out.width='60%', fig.width=5, fig.height=4}
ggplot( Amaurot ) + theme_bw() + geom_sf() +
  geom_point( data=Patients, aes( x=Lon, y=Lat, color=Lead ) ) + 
  scale_color_distiller( palette="Reds", trans="reverse" ) +
  labs( x="Longitude", y="Latitude", color="Lead",
        title="Lead Concentration across Amaurot")
```

<p style="color:blue">*The plot reveals that the highest lead levels are recorded north and south of the centre of Amaurot, with levels of over 20 parts per million. For other areas, concentrations close to 0 parts per million were recorded.*</p>


b) Perform inverse distance weighting to predict lead levels for all points in the file "Amaurot Grid.csv"; the points form a regular grid over the whole city and there is also information in which district the point lies. Comment on the reliability of your predictions.

<p style="color:blue">*We first load the IDW() function from the lecture notes:*</p>

```{r}
IDW <- function( X, S, s_star, p){
  d <- sqrt( (S[,1]-s_star[1])^2 + (S[,2]-s_star[2])^2 )
  w <- d^(-p)
  if( min(d) > 0 )
    return( sum( X * w ) / sum( w ) )
  else 
    return( X[d==0] )
}
```

<p style="color:blue">*We make use of the provided grid as it provides information on the district each grid cell is located in. We further introduce a new variable to store the predicted lead concentrations:*</p>

```{r}
Amaurot_Grid <- read.csv("data/Amaurot Grid.csv")
Amaurot_Grid <- Amaurot_Grid %>% mutate( Lead = NA )
```

<p style="color:blue">*Everything is now ready for us to perform inverse distance weighting. There are a few possible choices for the power parameter, but I would say that the plot for $p=2.5$ looks quite reasonable:*</p>

```{r}
coord <- cbind( Patients$Lon, Patients$Lat )
Grid  <- cbind( Amaurot_Grid$Lon, Amaurot_Grid$Lat )

for( i in 1:length(Grid[,1]) )
  Amaurot_Grid$Lead[i] <- IDW( X=Patients$Lead, S=coord, s_star=Grid[i,], p=2.5 )
```

<p style="color:blue">*Finally, we visualize the predicted lead concentrations:*</p>

```{r, fig.align='center', out.width='60%'}
ggplot() + theme_bw() +
  geom_tile( data=Amaurot_Grid, aes(x=Lon, y=Lat, fill=Lead) ) +
  scale_fill_distiller( palette="Reds", trans="reverse" ) +
  geom_sf( data=Amaurot, alpha=0.0, color="white", linewidth=0.7 ) + 
  labs( title="Lead concentration predictions for p=2.5", 
        fill="Lead", x="Longitude", y="Latitude" )
```

<p style="color:blue">*In terms of reliability, the use of the Euclidian distance is probably not a good choice since:*</p>

* <p style="color:blue">*Drinking water is transported via water pipes, and so two spatially close households may observe very different lead concentrations.*</p> 

* <p style="color:blue">*There is probably one more or sources which explain the high lead concentration. Due to households being serviced by a network of water pipes, households up to the point lead enters the system will be fine, while others further down the network may be affected.*</p>


c) The authorities want to reduce the occurrences of lead concentrations exceeding a level of 10 parts per million. They have thus decided to deploy a team to one of the districts with the job of reducing lead levels to below this threshold for all households in that districts. Use your results in part b) to identify which district should be targeted.

<p style="color:blue">*One option is to estimate for each district the proportion of households affected by a lead concentration above 10 parts per million (this requires certain assumptions):*</p>

```{r}
Amaurot_Grid %>% 
  group_by( District ) %>%
  summarise( AreaExceedingThreshold = mean(Lead>10) ) %>%
  slice_max( AreaExceedingThreshold, n=3 )
```

<p style="color:blue">*Our results suggest that almost all of District 13 would benefit from sending the team, with District 1 being a close second (we may also want to consider the size of the districts).*</p>
