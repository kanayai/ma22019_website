---
title: "MA22019 2025 - Solutions for Quiz 8"
author: "Semi-variogram and principal component analysis"
output:
  html_document: default
  pdf_document: default
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

You may want to load the following packages before starting the exercise:

```{r, message=FALSE, warning=FALSE}
library( dplyr )
library( lubridate )
library( ggplot2 )
library( tidyr )
library( sf )
library( ggspatial )
library( prettymapr )
library( sp )
library( gstat )
```

When working on a University PC, you will have to first install some of these packages. 



### **Exercise 1 - Exploring spatial structure in river flow data**

A data scientist used principal component analysis to explore the spatial structure / dependence in the daily maximum river flow values across 45 gauges in Northern England and the South of Scotland. They identified that the first 3 components explain more than 90% of the variation in the data and created the following plots representing the first three eigenvectors:

```{r, fig.align='center', out.width='100%', fig.width=12, fig.height=7, echo=FALSE, warning=FALSE, message=FALSE}
RF <- read.csv("River Flow.csv")
RF <- RF %>% na.omit() 
PCA <- prcomp( RF, scale. = TRUE )
Loc <- read.csv("Locations River Flow.csv")
Loc <- Loc %>%
  mutate( PC1 = PCA$rotation[,1], PC2 = PCA$rotation[,2], PC3 = PCA$rotation[,3] ) %>%
  pivot_longer( cols=PC1:PC3, names_to="PC" )
GB <- read_sf( "gadm41_GBR_shp (1)/gadm41_GBR_2.shp" )
GB <- GB %>% st_simplify( dTolerance = 500 )
ggplot( GB ) + geom_sf(fill="white") + theme_bw() +
  geom_point(data=Loc, aes(x=Lon,y=Lat,color=value), size=5 ) + 
  scale_color_distiller( palette="Blues" ) +
  xlim(-3.5,-1) + ylim(53,55.5) + 
  facet_wrap( ~PC ) +
  labs( x="Longitude", y="Latitude", color="value" )
```

Provide an interpretation for the three plots and then go to Moodle and complete the quiz.

* <p style="color:blue"> *All entries in the first eigenvector are positive. This indicates that given river flow is high at one site, it tends to be at all other gauges too.*</p>

* <p style="color:blue"> *The second eigenvector takes negatives values for sites located in Lake District, and more generally in the north-west of the study area. So this eigenvector indicates that there are differences between the gauges located in the Lake District (and sites to it) and the sites further south (around Manchester and Liverpool).*</p>

* <p style="color:blue"> *The third eigenvector shows a trend from the west to the east coast - it takes negative values for sites close to the west coast, while it is positive for the remaining sites. This eigenvector may represent how much the river flow at a gauge is influenced by weather moving in from a westerly direction.*</p>


### **Exercise 2 - Concentrations of zinc in the top soil**

The file "Meuse.csv" gives topsoil zinc concentrations (in mg/kg) collected across 155 locations in a flood plain of the river Meuse. Specifically, we are given

* Lon,Lat - Longitude and latitude coordinate of the locations

* Zinc - Zinc concentration on logarithmic scale

Perform the following steps to explore the spatial structure in the data:

a) Visualize the zinc concentration on logarithmic scale using the ggspatial package. What do you conclude?

<p style="color:blue"> *We start by loading the data:*</p>

```{r}
Meuse <- read.csv("Meuse.csv")
```

<p style="color:blue"> *We use the functions in the ggspatial package to visualize the data:*</p>

```{r, fig.align='center', out.width='65%', message=FALSE}
ggplot( Meuse, aes(x=Lon, y=Lat) ) + annotation_map_tile( zoom = 14 ) + 
  geom_spatial_point( aes(color=Zinc) ) + 
  scale_fill_distiller( palette="Reds", trans="reverse" ) +
  labs( x="Longitude", y="Latitude", color="Log(Zinc concentration)")
```

<p style="color:blue"> *We find that concentration tends to be higher for locations close to the river, while sites further away record lower values:*</p>


b) Explore the spatial dependence in the zinc concentration on logarithmic scale by estimating the semi-variogram for the data. Go to Moodle and answer the quiz.

<p style="color:blue"> *We first convert the data into spatial data points:*</p>

```{r}
Meuse_gamma <- Meuse
coordinates(Meuse_gamma) <- ~ Lon+Lat
```

<p style="color:blue"> *Now we can estimate and visualize the semi-variogram:*</p>

```{r, fig.align='center', out.width='60%', fig.height=3, fig.width=5}
gamma_hat <- variogram( Zinc~1, Meuse_gamma, cutoff=0.015  )
ggplot( gamma_hat, aes( x=dist, y=gamma/2 ) ) + geom_point( size=2 ) + 
  theme_bw() + labs( x="Distance", y="Semi-variogram" )
```

<p style="color:blue"> *We find that semi-variogram increases with increasing spatial up to a distance of about 0.01, at which it starts to level off. From this we can conclude that spatial dependence decreases with increasing spatial distance, i.e. there is stronger dependence between spatially close sites than between locations that are far apart. Further, for sites that further than 0.01 apart, zinc concentrations are close to independent.*</p>

<p style="color:blue"> *One may argue whether it's reasonable to assume that dependence is fully described by the distance between sites, since we saw that distance from the river seems to be an important factor explaining variables. As such one may want to add an explanatory variable (such as distance to the river) to the analysis, but such an approach is beyond this unit (a suitable framework may be introduced in Statistics 3B).*</p>

