---
title: "Problem Class 4"
author: "Dr. Karim Anaya-Izquierdo"
format: html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tidytext)
library(stringr)
```


## Background

Jane Austen wrote seven novels, and we consider six of these: *Emma*, *Mansfield Park*, *Northanger Abbey*, *Persuasion*, *Pride and Prejudice* and *Sense and Sensibility*. 

All novels are available via Project Gutenberg and we will analyze similarities and differences of the different books in the following. We start by loading the text data which is available in the file "Data/JaneAusten.csv" on Moodle:
  
```{r}
JaneAusten_raw <- read.csv( "Data/JaneAusten.csv" )
```

We will analyze the six books and

1) Identify the most common words (except stop words) for each book

2) Extract the words with the highest term frequency - inverse document frequency

3) Compare the six books in terms of their sentiment


## Word frequency analysis

As before, we first have to bring the data into a usable format and remove stop words.

**Task 1:** Split the lines of text into individual words and remove all stop words and underscores.

```{r}
JaneAusten <- JaneAusten_raw %>%
  unnest_tokens( word, text ) %>%
  mutate( word = gsub("_", "", word) ) %>%
  anti_join( stop_words, by="word" )
```

With the data in the desired format, we are ready to identify the most common words:

**Task 2:** Extract the ten most common words (excluding stop words) for each book.

```{r}
JaneAusten_Count <- JaneAusten %>%
  group_by( title ) %>%
  count( word, name = "Count", sort = TRUE ) %>%
  slice_head( n=10 )
```

After identifying the most frequent words, let's visualize them. The following piece of code produces for each book a bar plot which visualizes the number of occurrences of the words identified in Task 2, i.e., the bar plot for a book provides information on the ten most common words (excluding stop words) contained in that book.

```{r, out.width='100%', fig.align='center'}  
ggplot( JaneAusten_Count, 
        aes( x=Count, y=reorder_within(word,Count,title), fill=title ) ) + 
  facet_wrap( ~title, scales = "free" ) + 
  geom_col( show.legend = FALSE ) + 
  scale_y_reordered() + theme_bw() + 
  labs( x="Count", y="Word" )
```

**Task 3:** What is the benefit of using the functions **reorder_within()** and **scale_y_reordered()**? What do we conclude from the plot?

To conclude our analysis on the words used within the books, we want to calculate the tf-idf values for each term.

**Task 4:** Calculate the tf-idf value for each word and book. What do you conclude when considering the words with the highest tf-idf?

```{r}
JaneAusten_Count <- JaneAusten %>% count( title, word, sort=TRUE )
```

```{r}
JaneAusten_Count %>% 
  bind_tf_idf( word, title, n ) %>%
  arrange( desc(tf_idf) ) %>%
  slice_head(n=20)
```

## Sentiment analysis

Let's study the sentiment of the books using the AFINN sentiment lexicon:

```{r}
AFINN <- read.csv( "Data/AFINN Sentiment Lexicon.csv" )
```

We want to derive the sentiment score for each chapter in each book. To do this, we first need to identify which chapter each line belongs to. We can do this by adapting the code from Section 3.2 in the lecture notes:

```{r}
JaneAusten_chapters <- JaneAusten_raw %>%
  group_by( title ) %>%
  mutate( chapter = cumsum( str_detect(
    text, regex("^chapter ", ignore_case = TRUE)
  ) ) ) %>%
  filter( chapter > 0 ) %>%
  ungroup()
```

The next step is to split the lines of text into individual words and to match the words in the AFINN sentiment lexicon with the words in the books. As for Jane Eyre, we remove the word "miss" from the analysis:

```{r}
JaneAusten_AFINN <- JaneAusten_chapters %>%
  filter( chapter > 0 ) %>%
  unnest_tokens( word, text ) %>%
  mutate( word = gsub( "_", "", word ) ) %>%
  inner_join( AFINN, by = "word" ) %>% 
  filter( word != "miss" )
```
  
**Task 5:** Derive the aggregated sentiment score for each chapter using the AFINN sentiment lexicon.

```{r}
JaneAusten_AFINN <- JaneAusten_AFINN %>%
  group_by( title, chapter ) %>%
  summarise( sentiment = sum(value) )
```


We produce plots which illustrate the sentiment for the different chapters and books as follows:

```{r, out.width='95%', fig.align='center',  message=FALSE}
ggplot( JaneAusten_AFINN, aes( x=chapter, y=sentiment ) ) +
  facet_wrap( ~title, scales="free_x" ) +
  geom_col( aes( fill=title ), show.legend = FALSE ) + 
  theme_bw() + labs( x="Chapter", y="AFINN sentiment score" ) 
```

**Task 6:** What do we conclude?
