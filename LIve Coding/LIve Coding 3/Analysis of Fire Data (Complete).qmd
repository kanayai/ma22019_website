---
title: "Problem Class 3 - Solution"
author: "Dr. Karim Anaya-Izquierdo"
format: html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
```


## Background

The Utopian Fire Department has gathered data on their activities for 2022. They also managed to provide us with access to some data for the houses in Utopia. We are asked to use the data to address the following questions:

1) For each cause, explore how the frequency of fires varied across time of day.

2) Are there any differences in the risk of fire for the different types of property? 

3) What is the relation between the year a property was built and the risk of fire?

We will explore how we can apply the techniques seen so far to address the three questions. 


## Data Descriptions

We are provided with two data files for the analysis:

**Data/Fires.csv**: List of fires recorded by the Utopian Fire Department for 2022

* **Date**: Day and time the fire was reported

* **Cause**: Cause the fire was attributed to ("Cooking", "Electrical Fault", "Heating" or "Other")

* **RegisterNumber**: Identification number of the property as listed in the register of houses/properties

**Data/Housing Register.csv:** Register of houses/properties for Utopia at the beginning of 2022

* **ID**: Identification number of the property

* **Year**: Year the property was built

* **Type**: Type of property ("Flat", "Terraced", "Semi-detached" or "Detached")

* **Bedroom**: Number of bedrooms (studio apartments are counted as having 1 bedroom)


## Number of fires over time

We start by loading the data set "Data/Fires.csv" and converting the variable **Date** to the correct type:

```{r}
Fires <- read.csv( "Data/Fires.csv" )
Fires <- Fires %>% mutate( Date = ymd_hm( Date ) )
```

**Task 1:** Create a facet plot, where each subplot provides a histogram of the number of fires per hour of the day for a different cause.

<p style="color:blue">*One aspect we should consider is whether we use Cartesian or polar coordinates. Both options are reasonable in this case, and we can generate plots with polar coordinates using coord_polar(), as seen in this week's lecture:*</p>

```{r, fig.align='center', out.width='70%'}
ggplot( Fires, aes(x=hour(Date) ) ) + facet_wrap(~Cause) + 
  geom_histogram(bins=24) + coord_polar() +
  labs( x="Hour of the Day", y="Number of Fires" )
```

**Task 2:** What do you conclude from your plot produced in Task 1?

<p style="color:blue">*We conclude that*</p> 

* <p style="color:blue">*Fires related to cooking are more likely in the morning, around lunch and in the evening, which seems intuitive given that these are the times when people are likely to cook.*</p> 

* <p style="color:blue">*For fires caused by electrical faults we see a slightly higher number during daytime than during nighttime, but the differences are relatively small.*</p>

* <p style="color:blue">*Fires caused by heating have a higher frequency in the morning and evening than for the rest of the day.*</p> 

* <p style="color:blue">*Finally, for the category "Other", the highest number of fires is recorded between 9 and 15 o'clock.*</p> 


## Fire risk across type of property

We now move onto analyzing the risk of fire.

**Task 3:** How would you define "risk of fire" in this context?

<p style="color:blue">*One sensible definition is to say that it refers to the probability of a property reporting a fire.*</p> 

Let's load the data from the housing register and combine the two data sets

```{r}
Houses    <- read.csv( "Data/Housing Register.csv" )
Fire_Risk <- full_join( Fires, Houses, by=c("RegisterNumber"="ID") )
```

**Task 4:** Create a variable to indicate whether a house was affected by a fire in 2022 or not.

<p style="color:blue">*After joing the data sets, the properties which did not record a fire have a value of* $\mathrm{\texttt{NA}}$ *for the date of the fire. So we can use the Date column and the case_when() function to create this new variable:*</p> 

```{r}
Fire_Risk <- Fire_Risk %>%
  mutate( Fire = case_when( is.na(Date) == TRUE ~ 0,
                            is.na(Date) == FALSE ~ 1 )  )
```


**Task 5:** For each type of property, calculate the proportion of properties which reported a fire in 2022. What do you conclude?

<p style="color:blue">*Having defined the new variable, we can directly apply the functions group_by() and summarize() we have seen so often:*</p> 

```{r}
Fire_Risk %>% 
  group_by( Type ) %>%
  summarize( "Fire Risk" = round( mean(Fire), 4 ) )
```

<p style="color:blue">*We find that terraced houses are at the highest risk, followed by flats, with detached and semi-detached houses exhibiting the lowest risk. Letâ€™s consider whether there are differences when we consider the causes of fire for the different types of properties.*</p> 

**Task 6:** Explore whether some causes of fire are more frequent for certain types of property.

<p style="color:blue">*This is a tricky question. To answer it, we need to estimate the  distribution of causes for each type of property - so we need to focus on the which actually reported a fire. Let's start by calculating the number of fires per type of property and cause:*</p> 

```{r}
Fire_Type_Cause <- Fire_Risk %>%
  filter( Fire == 1 ) %>%
  count( Type, Cause )
slice_head(Fire_Type_Cause, n=5)
```

<p style="color:blue">*To calculate the proportions, we may use the pivot_wider() function to have all the values for one type of property in a separate row. This then allows us to calculate the proportion. One piece of code which does this is*</p> 

```{r}
Fire_Type_Cause %>%
  pivot_wider( names_from = Type, values_from = n ) %>%
  mutate( Detached = round( Detached / sum(Detached), 2), 
          Flat = round(Flat / sum(Flat), 2),
          `Semi-detached` = round( `Semi-detached` / sum(`Semi-detached`), 2), 
          Terraced = round(Terraced / sum(Terraced),2) )
```

<p style="color:blue">*We see that fires caused by heating are more frequent in detached and semi-detached houses, while electrical faults pose a higher fire risk for terraced houses.*</p>


## Relation between risk of fire and year built

**Task 7:** Create a data graphic to explore the relation between risk of fire and the year a property was built. What do you conclude?

<p style="color:blue">*This is a similar problem to that from the first lecture. While one may be tempted to just plot year built against risk of fire, a much better solution is to also include the type of property in the analysis. So we again create a facet plot:*</p>

```{r, fig.align='center', out.width='70%', message=FALSE}
ggplot( Fire_Risk, aes(x=Year, y=Fire) ) + 
  facet_wrap(~Type) + geom_smooth() +
  labs( x="Year Built", y="Fire Risk" )
```

<p style="color:blue">*We see that newer flats, detached and semi-detached properties are at a higher risk than their older counterparts, with the risk being twice as high when considering detached and semi-detached houses. For terraced houses, recently build houses are at about half the risk of the very old terraced houses.*</p>
